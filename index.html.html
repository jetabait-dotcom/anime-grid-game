<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Anime Game Hub - ศูนย์รวมเกมอนิเมะ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Anuphan:wght@300;400;500;600;700;800&display=swap');
        body { 
            background-color: #171717; 
            color: #f5f5f5; 
            font-family: 'Anuphan', sans-serif; 
            margin: 0; 
            overflow-x: hidden; 
            line-height: 1.6;
        }
        .text-gradient { background: linear-gradient(to right, #a78bfa, #f472b6); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .btn-primary { background-color: #4f46e5; transition: all 0.2s; }
        .thai-header { letter-spacing: 0.02em; line-height: 1.3; font-weight: 800; }
        .btn-primary:hover { background-color: #4338ca; transform: translateY(-1px); }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .animate-slide-up { animation: slideUp 0.4s ease-out forwards; }
        @keyframes crownBounce { 0%, 100% { transform: translateY(0) rotate(0); } 50% { transform: translateY(-10px) rotate(5deg); } }
        .animate-victory { animation: crownBounce 2s infinite ease-in-out; }
        .tier-row { min-height: 120px; transition: all 0.2s; position: relative; }
        .drag-over { background-color: rgba(79, 70, 229, 0.1) !important; border: 2px dashed #4f46e5 !important; }
        .item-drag-target { border-left: 4px solid #4f46e5 !important; margin-left: -2px; }
        .hint-pulse { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: .5; } }
    </style>
</head>
<body class="bg-[#171717]">
    <div id="root"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, updateDoc, onSnapshot, collection, arrayUnion } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDy3A8XwrKA-BXjlueZzzTa5BQ1R1SFVzk",
            authDomain: "game-hub-jetabait.firebaseapp.com",
            projectId: "game-hub-jetabait",
            storageBucket: "game-hub-jetabait.firebasestorage.app",
            messagingSenderId: "788930921640",
            appId: "1:788930921640:web:f54c7d47012b4f50a0ee9d",
            measurementId: "G-TL5GQ6BX61"
        };

        try {
            const app = initializeApp(firebaseConfig);
            const auth = getAuth(app);
            const db = getFirestore(app);
            window.FirebaseSDK = { auth, db, doc, setDoc, getDoc, updateDoc, onSnapshot, collection, signInAnonymously, signInWithCustomToken, onAuthStateChanged, arrayUnion };
        } catch (e) { console.error("Firebase Error", e); }
    </script>

    <script type="text/babel">
        const { useState, useEffect, useRef, Fragment, useCallback } = React;

        const Icon = ({ name, size = 24, className = "" }) => {
            const icons = {
                gamepad: <path d="M6 12h4m-2-2v4m7-1h.01m2.99-2h.01M2 6a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V6Z"/>,
                grid: <path d="M3 3h7v7H3V3Zm11 0h7v7h-7V3ZM3 14h7v7H3v-7Zm11 0h7v7h-7v-7Z"/>,
                back: <path d="m15 18-6-6 6-6"/>,
                users: <Fragment><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></Fragment>,
                user: <Fragment><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></Fragment>,
                search: <Fragment><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></Fragment>,
                close: <path d="M18 6 6 18M6 6l12 12"/>,
                check: <path d="M20 6 9 17l-5-5"/>,
                playCircle: <Fragment><circle cx="12" cy="12" r="10"/><polygon points="10 8 16 12 10 16 10 8"/></Fragment>,
                help: <Fragment><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><line x1="12" y1="17" x2="12.01" y2="17"/></Fragment>,
                sparkles: <path d="m12 3 1.912 5.885L20 10.8l-5.088 1.915L12 18.6l-1.912-5.885L5 10.8l5.088-1.915L12 3Z"/>,
                trophy: <path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6M18 9h1.5a2.5 2.5 0 0 0 0-5H18M4 22h16M10 14.66V17c0 .55.45 1 1 1h2c.55 0 1-.45 1-1v-2.34c3.12-.5 5-2.66 5-5.66V2H6v7c0 3 1.88 5.16 5 5.66z"/>,
                layers: <path d="m12.89 1.45 8 4.61a2 2 0 0 1 0 3.47l-8 4.61a2 2 0 0 1-2 0l-8-4.61a2 2 0 0 1 0-3.47l8-4.61a2 2 0 0 1 2 0z M2.11 12.57l8 4.61a2 2 0 0 0 2 0l8-4.61 M2.11 16.57l8 4.61a2 2 0 0 0 2 0l8-4.61" />,
                download: <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M7 10l5 5 5-5M12 15V3"/>,
                trash: <path d="M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2M10 11v6M14 11v6" />,
                book: <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20M4 19.5A2.5 2.5 0 0 0 6.5 22H20V5H6.5A2.5 2.5 0 0 0 4 7.5v12z" />,
                settings: <Fragment><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></Fragment>,
                message: <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z" />
            };
            return (
                <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                    {icons[name]}
                </svg>
            );
        };

        const shuffleAndPick = (arr, count) => [...arr].sort(() => Math.random() - 0.5).slice(0, count);

        function SearchInterface({ search, setSearch, searchType, setSearchType, results, searching, onSelect, onCancel }) {
            return (
                <div className="fixed inset-0 z-[500] flex items-center justify-center p-4 bg-black/90 backdrop-blur-md">
                    <div className="w-full max-w-xl bg-[#262626] rounded-[3rem] h-[85vh] flex flex-col animate-slide-up shadow-2xl overflow-hidden border border-white/5">
                        <div className="p-8 border-b border-white/5 flex justify-between items-center bg-[#2a2a2a]">
                            <h3 className="text-2xl font-bold thai-header">ค้นหารายการ</h3>
                            <button onClick={onCancel} className="text-neutral-500 hover:text-white transition-colors"><Icon name="close" /></button>
                        </div>
                        
                        <div className="flex border-b border-white/5 font-black bg-[#1a1a1a]">
                            <button onClick={() => setSearchType('anime')} className={`flex-1 py-5 text-lg thai-header transition-all ${searchType.includes('anime') ? 'text-indigo-400 border-b-2 border-indigo-400 bg-indigo-400/5' : 'text-neutral-500'}`}>อนิเมะ</button>
                            <button onClick={() => setSearchType('character')} className={`flex-1 py-5 text-lg thai-header transition-all ${searchType === 'character' ? 'text-pink-400 border-b-2 border-pink-400 bg-pink-500/5' : 'text-neutral-500'}`}>ตัวละคร</button>
                            <button onClick={() => setSearchType('custom')} className={`flex-1 py-5 text-lg thai-header transition-all ${searchType === 'custom' ? 'text-orange-400 border-b-2 border-orange-400 bg-orange-400/5' : 'text-neutral-500'}`}>พิมพ์เอง</button>
                        </div>

                        <div className="flex-1 overflow-y-auto p-4 custom-scrollbar">
                            {searchType !== 'custom' ? (
                                <Fragment>
                                    <div className="space-y-4 mb-6 px-2">
                                        <input autoFocus value={search} onChange={e => setSearch(e.target.value)} className="w-full bg-[#1a1a1a] border border-white/5 rounded-2xl p-4 text-white font-bold text-lg outline-none shadow-inner focus:ring-2 focus:ring-indigo-500/30" placeholder={searchType === 'character' ? "ค้นหาตัวละคร หรือชื่อเรื่องอนิเมะ..." : "พิมพ์ชื่ออนิเมะ..."} />
                                        {searchType === 'character' && <p className="text-[10px] text-neutral-500 font-bold px-2 uppercase tracking-wide thai-header">* พิมพ์ชื่อเรื่องอนิเมะ เพื่อดึงตัวละครจากเรื่องนั้นๆ ได้ทันที</p>}
                                    </div>

                                    <div className="grid grid-cols-4 sm:grid-cols-5 gap-2.5 px-2">
                                        {searching && <div className="col-span-full text-center text-indigo-400 animate-pulse font-black py-10 uppercase tracking-widest text-xs thai-header">กำลังค้นหา...</div>}
                                        {!searching && results.length === 0 && search.trim().length >= 2 && <div className="col-span-full text-center text-neutral-600 font-bold py-10 text-xs thai-header">ไม่พบผลลัพธ์</div>}
                                        {results.map((item, idx) => (
                                            <button key={idx} onClick={() => onSelect(item)} className="text-left group animate-slide-up flex flex-col">
                                                <div className="aspect-[3/4] rounded-lg overflow-hidden mb-1 bg-[#1a1a1a] group-hover:border-indigo-500/50 border border-white/5 shadow-sm">
                                                    <img src={item.image} className="w-full h-full object-cover group-hover:scale-110 transition-transform duration-300" />
                                                </div>
                                                <p className="text-[8px] font-bold text-neutral-400 group-hover:text-white line-clamp-1 thai-header leading-tight px-1 text-center">{item.title}</p>
                                            </button>
                                        ))}
                                    </div>
                                </Fragment>
                            ) : (
                                <div className="h-full flex flex-col items-center justify-center space-y-6">
                                    <div className="w-full text-center px-6">
                                        <p className="text-neutral-500 font-bold mb-4 thai-header">ระบุข้อมูลที่ต้องการ</p>
                                        <input autoFocus onKeyDown={e => {if(e.key === 'Enter' && e.target.value.trim()) onSelect({title: e.target.value})}} className="w-full bg-[#1a1a1a] border border-white/5 rounded-2xl p-6 text-white text-3xl font-black outline-none focus:ring-2 focus:ring-orange-500/30 text-center thai-header" placeholder="พิมพ์ชื่อ..." />
                                    </div>
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        }

        function App() {
            const [screen, setScreen] = useState('hub');
            const [user, setUser] = useState(null);
            const [fb, setFb] = useState(null);
            const [roomId, setRoomId] = useState('');
            const [gameType, setGameType] = useState('bingo');
            const [playerName, setPlayerName] = useState(localStorage.getItem('anime_player_name') || '');
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'game-hub-jetabait';

            useEffect(() => {
                const check = setInterval(() => {
                    if (window.FirebaseSDK) {
                        clearInterval(check);
                        const sdk = window.FirebaseSDK;
                        setFb(sdk);
                        sdk.onAuthStateChanged(sdk.auth, (u) => { if (u) setUser(u); });
                        const initAuth = async () => {
                            try {
                                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                                    await sdk.signInWithCustomToken(sdk.auth, __initial_auth_token);
                                } else {
                                    await sdk.signInAnonymously(sdk.auth);
                                }
                            } catch(e) { await sdk.signInAnonymously(sdk.auth); }
                        };
                        initAuth();
                    }
                }, 100);
            }, []);

            if (!user) return <div className="min-h-screen flex flex-col items-center justify-center text-indigo-400 font-bold animate-pulse text-2xl tracking-tight thai-header">กำลังเชื่อมต่อ...</div>;

            return (
                <div className="min-h-screen flex flex-col bg-[#171717]">
                    {screen === 'hub' && (
                        <div className="flex-1 flex flex-col items-center justify-center p-6 animate-slide-up text-center">
                            <h1 className="text-5xl md:text-6xl font-black text-gradient mb-12 tracking-tighter thai-header">Anime Game Hub</h1>
                            <div className="grid grid-cols-1 sm:grid-cols-3 gap-6 w-full max-w-4xl px-4">
                                <button onClick={() => {setGameType('bingo'); setScreen('lobby');}} className="bg-[#262626] p-8 md:p-10 rounded-[2.5rem] border border-white/5 hover:border-indigo-500/30 transition-all text-left group shadow-xl">
                                    <Icon name="grid" size={32} className="text-indigo-400 mb-6" />
                                    <h3 className="text-xl md:text-2xl font-bold mb-2 text-white thai-header">บิงโกกกก</h3>
                                    <p className="text-neutral-500 font-medium text-xs md:text-sm">ท้าทายหมวดหมู่จากอนิเมะ</p>
                                </button>
                                <button onClick={() => {setGameType('yesno'); setScreen('lobby');}} className="bg-[#262626] p-8 md:p-10 rounded-[2.5rem] border border-white/5 hover:border-pink-500/30 transition-all text-left group shadow-xl">
                                    <Icon name="help" size={32} className="text-pink-400 mb-6" />
                                    <h3 className="text-xl md:text-2xl font-bold mb-2 text-white thai-header">ทายมาสิน้อง</h3>
                                    <p className="text-neutral-500 font-medium text-xs md:text-sm">ทายตัวละครลับจากคำถาม</p>
                                </button>
                                <button onClick={() => {setGameType('tierlist'); setScreen('lobby');}} className="bg-[#262626] p-8 md:p-10 rounded-[2.5rem] border border-white/5 hover:border-orange-500/30 transition-all text-left group shadow-xl">
                                    <Icon name="layers" size={32} className="text-orange-400 mb-6" />
                                    <h3 className="text-xl md:text-2xl font-bold mb-2 text-white thai-header">จัดเทียร์</h3>
                                    <p className="text-neutral-500 font-medium text-xs md:text-sm">จัดอันดับตัวละครร่วมกับเพื่อน</p>
                                </button>
                            </div>
                        </div>
                    )}
                    {screen === 'lobby' && <Lobby fb={fb} appId={appId} gameType={gameType} onBack={() => setScreen('hub')} onJoin={(id) => {setRoomId(id); setScreen('game');}} user={user} playerName={playerName} setPlayerName={setPlayerName} />}
                    {screen === 'game' && gameType === 'bingo' && <BingoGame fb={fb} appId={appId} roomId={roomId} onBack={() => setScreen('hub')} user={user} playerName={playerName} />}
                    {screen === 'game' && gameType === 'yesno' && <GuessingGame fb={fb} appId={appId} roomId={roomId} onBack={() => setScreen('hub')} user={user} playerName={playerName} />}
                    {screen === 'game' && gameType === 'tierlist' && <TierListGame fb={fb} appId={appId} roomId={roomId} onBack={() => setScreen('hub')} user={user} playerName={playerName} />}
                </div>
            );
        }

        function Lobby({ fb, appId, gameType, onBack, onJoin, user, playerName, setPlayerName }) {
            const [roomCode, setRoomCode] = useState('');
            const displayTitles = { bingo: 'บิงโกกกก', yesno: 'ทายมาสิน้อง', tierlist: 'จัดเทียร์' };

            const handleAction = async (isCreate) => {
                if (!playerName.trim()) return;
                const id = isCreate ? Math.random().toString(36).substring(2, 5).toUpperCase() : roomCode.toUpperCase();
                const roomRef = fb.doc(fb.db, 'artifacts', appId, 'public', 'data', 'rooms', id);
                if (isCreate) {
                    const baseData = {
                        gameType, owner: user.uid, players: { [user.uid]: playerName }, playerOrder: [user.uid],
                        createdAt: new Date().toISOString(),
                        hints: {}
                    };
                    if (gameType === 'bingo') {
                        Object.assign(baseData, { grid: Array(9).fill(null), gridSize: 3, turnUid: user.uid });
                    }
                    await fb.setDoc(roomRef, baseData);
                    onJoin(id);
                } else {
                    const snap = await fb.getDoc(roomRef);
                    if (snap.exists()) {
                        const data = snap.data();
                        const newOrder = data.playerOrder || [];
                        if (!newOrder.includes(user.uid)) newOrder.push(user.uid);
                        await fb.updateDoc(roomRef, { [`players.${user.uid}`]: playerName, playerOrder: newOrder });
                        onJoin(id);
                    } else { alert("ไม่พบห้องที่ระบุ"); }
                }
            };
            return (
                <div className="flex-1 flex flex-col items-center justify-center p-6 animate-slide-up">
                    <div className="w-full max-w-sm bg-[#262626] p-8 rounded-[2.5rem] border border-white/5 shadow-2xl">
                        <button onClick={onBack} className="text-neutral-500 mb-6 flex items-center font-bold text-[10px] hover:text-white transition-colors thai-header"><Icon name="back" size={12} className="mr-1" /> กลับหน้าหลัก</button>
                        <h2 className="text-xl font-black mb-6 text-center text-gradient uppercase thai-header">โหมด {displayTitles[gameType]}</h2>
                        <div className="space-y-4">
                            <input value={playerName} onChange={e => {setPlayerName(e.target.value); localStorage.setItem('anime_player_name', e.target.value);}} className="w-full bg-[#1a1a1a] border border-white/5 rounded-xl px-5 py-3 text-white font-bold focus:outline-none focus:ring-1 focus:ring-indigo-500/50" placeholder="ใส่ชื่อเล่นของคุณ" />
                            <button onClick={() => handleAction(true)} className="w-full btn-primary py-3 rounded-xl font-black shadow-lg thai-header text-sm">สร้างห้องใหม่</button>
                            <div className="relative flex items-center py-1"><div className="flex-grow border-t border-white/5"></div><span className="flex-shrink mx-3 text-neutral-600 text-[9px] font-bold uppercase thai-header">หรือเข้าร่วม</span><div className="flex-grow border-t border-white/5"></div></div>
                            <div className="flex gap-2">
                                <input value={roomCode} onChange={e => setRoomCode(e.target.value)} className="flex-1 bg-[#1a1a1a] border border-white/5 rounded-xl px-5 py-3 text-white font-mono uppercase focus:outline-none" placeholder="รหัสห้อง" />
                                <button onClick={() => handleAction(false)} className="bg-[#333] px-4 rounded-xl font-black text-xs transition-all hover:bg-[#444] thai-header">ตกลง</button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        // --- BINGO GAME COMPONENT ---
        function BingoGame({ fb, appId, roomId, onBack, user, playerName }) {
            const [grid, setGrid] = useState([]);
            const [gridSize, setGridSize] = useState(3);
            const [turnUid, setTurnUid] = useState(null);
            const [winnerUid, setWinnerUid] = useState(null);
            const [activeCell, setActiveCell] = useState(null);
            const [search, setSearch] = useState('');
            const [searchType, setSearchType] = useState('anime');
            const [results, setResults] = useState([]);
            const [searching, setSearching] = useState(false);
            const [players, setPlayers] = useState({});

            useEffect(() => {
                const roomRef = fb.doc(fb.db, 'artifacts', appId, 'public', 'data', 'rooms', roomId);
                return fb.onSnapshot(roomRef, (snap) => {
                    if (snap.exists()) {
                        const d = snap.data();
                        setGridSize(d.gridSize || 3);
                        setGrid(d.grid || Array((d.gridSize || 3)**2).fill(null));
                        setTurnUid(d.turnUid);
                        setWinnerUid(d.winnerUid);
                        setPlayers(d.players || {});
                    }
                });
            }, []);

            useEffect(() => {
                if (searchType !== 'custom' && search.trim().length >= 2) {
                    const timer = setTimeout(async () => {
                        setSearching(true);
                        try {
                            const url = searchType === 'anime' ? `https://api.jikan.moe/v4/anime?q=${encodeURIComponent(search)}&limit=15` : `https://api.jikan.moe/v4/characters?q=${encodeURIComponent(search)}&limit=25`;
                            const r = await fetch(url);
                            const d = await r.json();
                            setResults(d.data?.map(m => ({ id: m.mal_id, title: m.title_english || m.title || m.name, image: m.images.webp.large_image_url || m.images.webp.image_url })) || []);
                        } catch(e) {} finally { setSearching(false); }
                    }, 600);
                    return () => clearTimeout(timer);
                } else setResults([]);
            }, [search, searchType]);

            return (
                <div className="flex-1 p-6 flex flex-col items-center animate-slide-up">
                    <div className="w-full max-w-4xl flex flex-wrap justify-between items-center mb-6 gap-4 bg-[#262626]/50 p-4 rounded-[2rem] border border-white/5">
                        <button onClick={onBack} className="text-neutral-500 font-bold flex items-center hover:text-white transition-colors thai-header px-4"><Icon name="back" className="mr-2" size={18} /> ออก</button>
                        <div className="flex items-center gap-2 bg-[#1a1a1a] p-1.5 rounded-xl border border-white/5">
                            <div className="flex -space-x-2 overflow-hidden px-2 max-w-[150px]">
                                {Object.entries(players).map(([uid, name]) => <div key={uid} title={name} className={`w-7 h-7 rounded-full border-2 flex items-center justify-center text-[10px] font-black uppercase shrink-0 ${uid === turnUid ? 'bg-indigo-600 border-indigo-400 text-white ring-2 ring-indigo-500/30 z-10' : 'bg-[#333] border-[#444] text-neutral-400'}`}>{name.charAt(0)}</div>)}
                            </div>
                            <div className="bg-indigo-600/20 px-4 py-1.5 rounded-lg font-mono text-indigo-400 font-black text-xs tracking-widest uppercase">ห้อง: {roomId}</div>
                        </div>
                    </div>
                    <div className="bg-[#262626] p-4 md:p-8 rounded-[3rem] border border-white/5 w-full max-w-3xl overflow-x-auto shadow-2xl custom-scrollbar">
                        <div className="grid gap-2" style={{ gridTemplateColumns: `repeat(${gridSize}, minmax(0, 1fr))` }}>
                            {grid.map((cell, idx) => (
                                <button key={idx} disabled={!!cell || winnerUid} onClick={() => setActiveCell(idx)} className={`aspect-square rounded-2xl overflow-hidden relative border border-white/5 ${cell ? (cell.uid === user.uid ? 'border-4 border-green-500' : 'border-4 border-pink-500 opacity-80') : 'bg-[#1a1a1a]'}`}>
                                    {cell ? (cell.image ? <img src={cell.image} className="w-full h-full object-cover" /> : <div className="p-2 text-center text-[10px] font-black text-white thai-header leading-tight">{cell.title}</div>) : (user.uid === turnUid && <div className="text-indigo-500/20 text-4xl font-black">+</div>)}
                                </button>
                            ))}
                        </div>
                    </div>
                    {activeCell !== null && <SearchInterface search={search} setSearch={setSearch} searchType={searchType} setSearchType={setSearchType} results={results} searching={searching} onSelect={async (item) => {
                        const roomRef = fb.doc(fb.db, 'artifacts', appId, 'public', 'data', 'rooms', roomId);
                        const latest = [...grid];
                        latest[activeCell] = { title: item.title, image: item.image, uid: user.uid };
                        await fb.updateDoc(roomRef, { grid: latest, turnUid: user.uid });
                        setActiveCell(null);
                    }} onCancel={() => setActiveCell(null)} />}
                </div>
            );
        }

        // --- GUESSING GAME COMPONENT ---
        function GuessingGame({ fb, appId, roomId, onBack, user, playerName }) {
            const [roomData, setRoomData] = useState(null);
            const [search, setSearch] = useState('');
            const [searchType, setSearchType] = useState('anime'); 
            const [results, setResults] = useState([]);
            const [picking, setPicking] = useState(false);
            const [searching, setSearching] = useState(false);
            const [hintInputs, setHintInputs] = useState({});

            useEffect(() => {
                const roomRef = fb.doc(fb.db, 'artifacts', appId, 'public', 'data', 'rooms', roomId);
                return fb.onSnapshot(roomRef, (snap) => { if (snap.exists()) setRoomData(snap.data()); });
            }, []);

            useEffect(() => {
                if (searchType !== 'custom' && search.trim().length >= 2) {
                    const t = setTimeout(async () => {
                        setSearching(true);
                        try {
                            if (searchType === 'character') {
                                const animeRes = await fetch(`https://api.jikan.moe/v4/anime?q=${encodeURIComponent(search)}&limit=1`);
                                const animeData = await animeRes.json();
                                if (animeData.data && animeData.data.length > 0) {
                                    const charRes = await fetch(`https://api.jikan.moe/v4/anime/${animeData.data[0].mal_id}/characters`);
                                    const charData = await charRes.json();
                                    if (charData.data) { setResults(charData.data.map(c => ({ title: c.character.name, image: c.character.images.webp.image_url }))); setSearching(false); return; }
                                }
                                const res = await fetch(`https://api.jikan.moe/v4/characters?q=${encodeURIComponent(search)}&limit=30`);
                                const d = await res.json();
                                setResults(d.data?.map(m => ({ title: m.name, image: m.images.webp.image_url })) || []);
                            } else {
                                const r = await fetch(`https://api.jikan.moe/v4/anime?q=${encodeURIComponent(search)}&limit=15`);
                                const d = await r.json();
                                setResults(d.data?.map(m => ({ title: m.title_english || m.title || m.name, image: m.images.webp.large_image_url || m.images.webp.image_url })) || []);
                            }
                        } catch(e) {} finally { setSearching(false); }
                    }, 600);
                    return () => clearTimeout(t);
                } else setResults([]);
            }, [search, searchType]);

            const setSecret = async (item) => {
                const roomRef = fb.doc(fb.db, 'artifacts', appId, 'public', 'data', 'rooms', roomId);
                await fb.updateDoc(roomRef, { [`secrets.${user.uid}`]: { title: item.title, image: item.image || null }, [`reveals.${user.uid}`]: false });
                setPicking(false); setSearch('');
            };

            const requestHint = async (targetUid, syl) => {
                const roomRef = fb.doc(fb.db, 'artifacts', appId, 'public', 'data', 'rooms', roomId);
                const hintId = `hint_${Date.now()}_${Math.random().toString(36).substring(7)}`;
                await fb.updateDoc(roomRef, { [`hints.${targetUid}.${user.uid}.${hintId}`]: { type: syl, text: null, status: 'requested', createdAt: Date.now() } });
            };

            if (!roomData) return null;

            const myNameInDb = roomData.players?.[user.uid] || playerName || '';
            // God Mode Check (JETABAIT Case-insensitive)
            const isGodUser = myNameInDb.toLowerCase() === 'jetabait';
            const myHintsRequestedFromOthers = roomData.hints?.[user.uid] || {};

            return (
                <div className="flex-1 p-6 flex flex-col items-center animate-slide-up">
                    <div className="w-full max-w-4xl flex flex-wrap justify-between items-center mb-10 bg-[#262626]/50 p-4 rounded-[2rem] border border-white/5">
                        <div className="flex items-center gap-4">
                            <button onClick={onBack} className="text-neutral-500 font-bold flex items-center hover:text-white transition-colors thai-header px-4"><Icon name="back" size={18} /> ออก</button>
                            
                            {/* God Mode Shortcut - Only visible to Jetabait */}
                            {isGodUser && (
                                <div className="flex gap-2 text-[10px] font-bold text-indigo-400 items-center overflow-x-auto custom-scrollbar max-w-[200px] md:max-w-md ml-2 border-l border-white/10 pl-4">
                                    <span className="text-neutral-500 shrink-0">เฉลย:</span>
                                    {Object.entries(roomData.secrets || {}).map(([uid, secret]) => (
                                        uid !== user.uid && (
                                            <div key={uid} className="whitespace-nowrap bg-indigo-500/10 px-2 py-1 rounded border border-indigo-500/20">
                                                <span className="text-neutral-500">{roomData.players[uid]}:</span> {secret.title}
                                            </div>
                                        )
                                    ))}
                                    {Object.keys(roomData.secrets || {}).length <= 1 && <span className="text-neutral-600 italic">รอเพื่อนเลือก...</span>}
                                </div>
                            )}
                        </div>

                        <div className="flex items-center gap-4">
                            <div className="bg-pink-600/20 px-4 py-2 rounded-xl text-pink-400 font-black text-xs uppercase thai-header tracking-wider shrink-0">ทายตัวละครลับ {isGodUser && <span className="ml-2 bg-indigo-500 text-white px-2 rounded-full text-[8px]">GOD</span>}</div>
                            <div className="bg-neutral-800 px-4 py-2 rounded-xl font-mono text-neutral-400 font-black text-xs tracking-widest uppercase shrink-0">ห้อง: {roomId}</div>
                        </div>
                    </div>
                    
                    <div className="w-full max-w-4xl grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div className="space-y-6">
                            <div className="bg-[#262626] p-8 rounded-[3rem] border border-white/5 shadow-2xl flex flex-col items-center text-center">
                                <h3 className="text-xl font-black text-neutral-500 mb-6 uppercase thai-header tracking-widest">ของฉัน</h3>
                                {roomData.secrets?.[user.uid] ? (
                                    <div className="w-full space-y-4">
                                        <div className="bg-indigo-500/10 border-2 border-indigo-500/30 p-6 rounded-[2rem] w-full animate-slide-up">
                                            {roomData.secrets[user.uid].image && <img src={roomData.secrets[user.uid].image} className="w-20 h-28 object-cover rounded-xl mx-auto mb-4 border border-indigo-500/30 shadow-lg" />}
                                            <p className="text-2xl font-black text-indigo-400 leading-tight thai-header">{roomData.secrets[user.uid].title}</p>
                                        </div>
                                        {!roomData.reveals?.[user.uid] && <button onClick={async () => await fb.updateDoc(fb.doc(fb.db, 'artifacts', appId, 'public', 'data', 'rooms', roomId), { [`reveals.${user.uid}`]: true })} className="w-full py-4 bg-red-600/20 text-red-400 border border-red-500/30 rounded-2xl font-black text-sm hover:bg-red-600 hover:text-white transition-all thai-header">เฉลยเลย</button>}
                                    </div>
                                ) : <button onClick={() => setPicking(true)} className="w-full py-14 border-4 border-dashed border-white/5 rounded-[2.5rem] text-indigo-400 font-black text-xl hover:bg-indigo-500/5 transition-all thai-header">เลือกตัวละครลับ</button>}
                            </div>

                            {/* Hint Requests Management */}
                            {Object.entries(myHintsRequestedFromOthers).some(([_, obj]) => Object.values(obj).some(h => h.status === 'requested')) && (
                                <div className="bg-[#262626] p-6 rounded-[2rem] border border-indigo-500/30 shadow-2xl space-y-4">
                                    <h4 className="text-xs font-black text-indigo-400 uppercase tracking-widest flex items-center gap-2 thai-header"><Icon name="message" size={14} /> มีเพื่อนขอคำใบ้!</h4>
                                    {Object.entries(myHintsRequestedFromOthers).map(([reqId, hintsObj]) => (
                                        Object.entries(hintsObj).filter(([_, h]) => h.status === 'requested').map(([hintId, hint]) => (
                                            <div key={hintId} className="bg-[#1a1a1a] p-4 rounded-xl border border-white/5 space-y-2 animate-slide-up">
                                                <p className="text-[10px] font-bold text-neutral-400 thai-header uppercase">{roomData.players[reqId]} ขอแบบ {hint.type} พยางค์</p>
                                                <div className="flex gap-2">
                                                    <input value={hintInputs[hintId] || ''} onChange={e => setHintInputs(p => ({...p, [hintId]: e.target.value}))} className="flex-1 bg-[#171717] rounded-lg px-3 py-1.5 text-xs text-white outline-none" placeholder="..." />
                                                    <button onClick={async () => {
                                                        const val = hintInputs[hintId]; if(!val) return;
                                                        await fb.updateDoc(fb.doc(fb.db, 'artifacts', appId, 'public', 'data', 'rooms', roomId), { [`hints.${user.uid}.${reqId}.${hintId}.text`]: val, [`hints.${user.uid}.${reqId}.${hintId}.status`]: 'provided' });
                                                    }} className="bg-indigo-600 px-4 rounded-lg text-[10px] font-black">ส่ง</button>
                                                </div>
                                            </div>
                                        ))
                                    ))}
                                </div>
                            )}
                        </div>

                        <div className="bg-[#262626] p-8 rounded-[3rem] border border-white/5 shadow-2xl">
                            <h3 className="text-xl font-black text-neutral-500 mb-6 uppercase thai-header tracking-widest">ผู้เล่นคนอื่น</h3>
                            <div className="space-y-4 max-h-[60vh] overflow-y-auto custom-scrollbar pr-2">
                                {Object.entries(roomData.players).filter(([id]) => id !== user.uid).map(([uid, name]) => {
                                    const secret = roomData.secrets?.[uid];
                                    const revealed = roomData.reveals?.[uid];
                                    const hintsToMe = roomData.hints?.[uid]?.[user.uid] || {};
                                    const hintEntries = Object.entries(hintsToMe).sort((a,b)=>b[1].createdAt-a[1].createdAt);
                                    
                                    // Visual for other players (only God user sees secret early)
                                    const canSeeEarly = isGodUser && secret;

                                    return (
                                        <div key={uid} className={`p-5 rounded-2xl border transition-all ${revealed ? 'bg-pink-500/5 border-pink-500/20' : canSeeEarly ? 'bg-indigo-500/5 border-indigo-500/20' : 'bg-[#1a1a1a] border-white/5'}`}>
                                            <div className="flex justify-between items-center">
                                                <div className="flex flex-col">
                                                    <span className="font-black text-lg thai-header uppercase">{name}</span>
                                                    {canSeeEarly && !revealed && <span className="text-[7px] text-indigo-400 font-bold uppercase tracking-tighter">เห็นผ่านพลังพระเจ้า</span>}
                                                </div>
                                                {revealed && <span className="text-[8px] bg-pink-500 text-white px-2 py-0.5 rounded-full font-black thai-header">เฉลยแล้ว</span>}
                                            </div>
                                            {revealed ? (
                                                <div className="mt-4 pt-4 border-t border-white/5 flex flex-col items-center animate-slide-up text-center">
                                                    {secret.image && <img src={secret.image} className="w-16 h-24 object-cover rounded-lg mb-2 shadow-md" />}
                                                    <p className="font-black text-indigo-400 thai-header">{secret.title}</p>
                                                </div>
                                            ) : (
                                                <div className="mt-4 space-y-3">
                                                    <div className="flex gap-1.5 flex-wrap">
                                                        <span className="text-[10px] font-black text-neutral-500 w-full mb-1 thai-header uppercase">ขอคำใบ้:</span>
                                                        {[1, 2, 3].map(n => {
                                                            const requested = Object.values(hintsToMe).some(h => h.type === n);
                                                            return (
                                                                <button key={n} disabled={!secret || requested} onClick={() => requestHint(uid, n)} className={`px-2 py-1 rounded-lg text-[10px] font-black border transition-all ${requested ? 'bg-indigo-600/20 text-indigo-400 border-indigo-500/10' : secret ? 'bg-indigo-600 text-white shadow-sm active:scale-95' : 'bg-neutral-800 text-neutral-600 cursor-not-allowed'}`}>
                                                                    {n} พยางค์ {requested && '✓'}
                                                                </button>
                                                            );
                                                        })}
                                                    </div>
                                                    <div className="space-y-1.5">{hintEntries.map(([hid, h]) => (
                                                        h.status === 'provided' && (
                                                            <div key={hid} className="bg-green-500/5 border border-green-500/20 p-2.5 rounded-xl animate-slide-up">
                                                                <p className="text-xs font-black text-white thai-header leading-tight italic">"{h.text}" <span className="text-[8px] text-green-500 opacity-70">({h.type} พยางค์)</span></p>
                                                            </div>
                                                        )
                                                    ))}</div>
                                                </div>
                                            )}
                                        </div>
                                    );
                                })}
                            </div>
                        </div>
                    </div>
                    {picking && <SearchInterface search={search} setSearch={setSearch} searchType={searchType} setSearchType={setSearchType} results={results} searching={searching} onSelect={setSecret} onCancel={() => setPicking(false)} />}
                </div>
            );
        }

        // --- TIERLIST GAME COMPONENT ---
        function TierListGame({ fb, appId, roomId, onBack, user, playerName }) {
            const [roomData, setRoomData] = useState(null);
            const [search, setSearch] = useState('');
            const [searchType, setSearchType] = useState('anime_single');
            const [results, setResults] = useState([]);
            const [searching, setSearching] = useState(false);
            const [adding, setAdding] = useState(false);

            useEffect(() => {
                const roomRef = fb.doc(fb.db, 'artifacts', appId, 'public', 'data', 'rooms', roomId);
                return fb.onSnapshot(roomRef, (snap) => { if (snap.exists()) setRoomData(snap.data()); });
            }, []);

            useEffect(() => {
                if (search.trim().length >= 2) {
                    const t = setTimeout(async () => {
                        setSearching(true);
                        try {
                            const url = searchType === 'character' ? `https://api.jikan.moe/v4/characters?q=${encodeURIComponent(search)}&limit=30` : `https://api.jikan.moe/v4/anime?q=${encodeURIComponent(search)}&limit=15`;
                            const r = await fetch(url);
                            const d = await r.json();
                            setResults(d.data?.map(m => ({ id: m.mal_id, title: m.title_english || m.title || m.name, image: m.images?.webp?.large_image_url || m.images?.webp?.image_url })) || []);
                        } catch(e) {} finally { setSearching(false); }
                    }, 600);
                    return () => clearTimeout(t);
                } else setResults([]);
            }, [search, searchType]);

            return (
                <div className="flex-1 p-6 flex flex-col items-center animate-slide-up">
                    <div className="w-full max-w-4xl flex flex-wrap justify-between items-center mb-8 bg-[#262626]/50 p-4 rounded-[2rem] border border-white/5">
                        <button onClick={onBack} className="text-neutral-500 font-bold flex items-center hover:text-white transition-colors thai-header px-4"><Icon name="back" size={18} /> ออก</button>
                        <div className="flex items-center gap-3">
                            <button onClick={() => setAdding(true)} className="bg-orange-600 text-white px-5 py-2 rounded-xl font-bold flex items-center hover:bg-orange-700 transition-all shadow-md text-xs thai-header"><Icon name="sparkles" size={16} className="mr-1.5" /> เพิ่มรูป</button>
                            <div className="bg-orange-600/20 px-4 py-2 rounded-lg font-mono text-orange-400 font-black text-xs tracking-widest uppercase">ห้อง: {roomId}</div>
                        </div>
                    </div>
                    <div className="w-full max-w-4xl space-y-4">
                        {[{id:'S', c:'bg-red-500'}, {id:'A', c:'bg-orange-500'}, {id:'B', c:'bg-yellow-500'}, {id:'C', c:'bg-green-500'}, {id:'D', c:'bg-blue-500'}].map(t => (
                            <div key={t.id} className="flex bg-[#262626] rounded-2xl overflow-hidden border border-white/5 shadow-xl">
                                <div className={`${t.c} w-20 flex items-center justify-center font-black text-2xl text-black/70 shadow-inner shrink-0`}>{t.id}</div>
                                <div className="flex-1 p-4 min-h-[120px] flex flex-wrap gap-2">
                                    {(roomData?.tierItems || []).filter(i => i.tier === t.id).map(item => (
                                        <div key={item.instanceId} className="relative group shrink-0"><img src={item.image} className="w-14 h-20 object-cover rounded-lg border border-white/5 shadow-sm" /></div>
                                    ))}
                                </div>
                            </div>
                        ))}
                    </div>
                    {adding && <SearchInterface search={search} setSearch={setSearch} searchType={searchType === 'anime_single' ? 'anime' : searchType} setSearchType={(t) => setSearchType(t === 'anime' ? 'anime_single' : t)} results={results} searching={searching} onSelect={async (r) => {
                        const roomRef = fb.doc(fb.db, 'artifacts', appId, 'public', 'data', 'rooms', roomId);
                        await fb.updateDoc(roomRef, { tierItems: fb.arrayUnion({ ...r, instanceId: Math.random().toString(36).substring(7), tier: 'S' }) });
                        setAdding(false);
                    }} onCancel={() => setAdding(false)} />}
                </div>
            );
        }

        const root = document.getElementById('root');
        ReactDOM.createRoot(root).render(<App />);
    </script>
</body>
</html>

