<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Anime Game Hub - Multiplayer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Anuphan:wght@300;400;500;600;700;800&display=swap');
        body { background-color: #171717; color: #f5f5f5; font-family: 'Anuphan', sans-serif; margin: 0; overflow-x: hidden; }
        .text-gradient { background: linear-gradient(to right, #a78bfa, #f472b6); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .btn-primary { background-color: #4f46e5; transition: all 0.2s; }
        .btn-primary:hover { background-color: #4338ca; transform: translateY(-1px); }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .animate-slide-up { animation: slideUp 0.4s ease-out forwards; }
        @keyframes crownBounce { 0%, 100% { transform: translateY(0) rotate(0); } 50% { transform: translateY(-10px) rotate(5deg); } }
        .animate-victory { animation: crownBounce 2s infinite ease-in-out; }
        .tier-row { min-height: 100px; transition: background-color 0.2s; }
    </style>
</head>
<body class="bg-[#171717]">
    <div id="root"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, updateDoc, onSnapshot, collection, arrayUnion } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDy3A8XwrKA-BXjlueZzzTa5BQ1R1SFVzk",
            authDomain: "game-hub-jetabait.firebaseapp.com",
            projectId: "game-hub-jetabait",
            storageBucket: "game-hub-jetabait.firebasestorage.app",
            messagingSenderId: "788930921640",
            appId: "1:788930921640:web:f54c7d47012b4f50a0ee9d",
            measurementId: "G-TL5GQ6BX61"
        };

        try {
            const app = initializeApp(firebaseConfig);
            const auth = getAuth(app);
            const db = getFirestore(app);
            window.FirebaseSDK = { auth, db, doc, setDoc, getDoc, updateDoc, onSnapshot, collection, signInAnonymously, signInWithCustomToken, onAuthStateChanged, arrayUnion };
        } catch (e) { console.error("Firebase Error", e); }
    </script>

    <script type="text/babel">
        const { useState, useEffect, useRef, Fragment } = React;

        const Icon = ({ name, size = 24, className = "" }) => {
            const icons = {
                gamepad: <path d="M6 12h4m-2-2v4m7-1h.01m2.99-2h.01M2 6a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V6Z"/>,
                grid: <path d="M3 3h7v7H3V3Zm11 0h7v7h-7V3ZM3 14h7v7H3v-7Zm11 0h7v7h-7v-7Z"/>,
                back: <path d="m15 18-6-6 6-6"/>,
                users: <Fragment><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></Fragment>,
                user: <Fragment><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></Fragment>,
                search: <Fragment><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></Fragment>,
                close: <path d="M18 6 6 18M6 6l12 12"/>,
                check: <path d="M20 6 9 17l-5-5"/>,
                playCircle: <Fragment><circle cx="12" cy="12" r="10"/><polygon points="10 8 16 12 10 16 10 8"/></Fragment>,
                edit: <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>,
                help: <Fragment><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><line x1="12" y1="17" x2="12.01" y2="17"/></Fragment>,
                sparkles: <path d="m12 3 1.912 5.885L20 10.8l-5.088 1.915L12 18.6l-1.912-5.885L5 10.8l5.088-1.915L12 3Z"/>,
                info: <Fragment><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></Fragment>,
                trophy: <path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6M18 9h1.5a2.5 2.5 0 0 0 0-5H18M4 22h16M10 14.66V17c0 .55.45 1 1 1h2c.55 0 1-.45 1-1v-2.34c3.12-.5 5-2.66 5-5.66V2H6v7c0 3 1.88 5.16 5 5.66z"/>,
                eye: <Fragment><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"/><circle cx="12" cy="12" r="3"/></Fragment>,
                layers: <path d="m12.89 1.45 8 4.61a2 2 0 0 1 0 3.47l-8 4.61a2 2 0 0 1-2 0l-8-4.61a2 2 0 0 1 0-3.47l8-4.61a2 2 0 0 1 2 0z M2.11 12.57l8 4.61a2 2 0 0 0 2 0l8-4.61 M2.11 16.57l8 4.61a2 2 0 0 0 2 0l8-4.61" />,
                download: <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M7 10l5 5 5-5M12 15V3"/>
            };
            return (
                <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                    {icons[name]}
                </svg>
            );
        };

        const CAT_PHYSICAL = ["Girl", "Boy", "Pink Hair", "Two-toned Hair", "Orange Hair", "Brown Hair", "Gray Hair", "White Hair", "Blue Hair", "Blonde Hair", "Green Hair", "Red Hair", "Purple Hair", "Short Hair", "Long Hair", "Bald", "Eyepatch", "Tattoo", "Scar", "Glasses", "Hat", "Mask", "Cape", "Scarf", "Suit", "Wings", "Tail", "Fangs", "Horns", "Muscular", "Robot", "Cyborg", "Tan Skin", "Elderly", "Child", "Non-Human", "Student"];
        const CAT_TRAITS = ["Fire Power", "Water Power", "Thunder Power", "Ice Power", "Psychic", "Shapeshifter", "Protagonist", "Villain", "Heroine", "Clown", "Animal-like", "God", "Demon", "Vampire", "Elf", "Alien", "Teacher", "Sword User", "Gun User", "Mage", "Knight", "Idol", "Musician", "Royalty", "Maid/Butler", "Yakuza", "Pirate", "Ninja", "Chef", "Doctor", "Detective", "Spy", "Sibling", "Pet Owner", "Isekai", "Thriller", "Slice of Life", "School Life", "Comedy", "Romance", "Sci-Fi", "Mystery", "Horror", "Sports", "Future World", "Harem", "Drama"];

        const shuffleAndPick = (arr, count) => [...arr].sort(() => Math.random() - 0.5).slice(0, count);

        function App() {
            const [screen, setScreen] = useState('hub');
            const [user, setUser] = useState(null);
            const [fb, setFb] = useState(null);
            const [roomId, setRoomId] = useState('');
            const [gameType, setGameType] = useState('bingo');
            const [playerName, setPlayerName] = useState(localStorage.getItem('anime_player_name') || '');
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'game-hub-jetabait';

            useEffect(() => {
                const check = setInterval(() => {
                    if (window.FirebaseSDK) {
                        clearInterval(check);
                        const sdk = window.FirebaseSDK;
                        setFb(sdk);
                        sdk.onAuthStateChanged(sdk.auth, (u) => { if (u) setUser(u); });
                        const initAuth = async () => {
                            try {
                                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                                    await sdk.signInWithCustomToken(sdk.auth, __initial_auth_token);
                                } else {
                                    await sdk.signInAnonymously(sdk.auth);
                                }
                            } catch(e) { await sdk.signInAnonymously(sdk.auth); }
                        };
                        initAuth();
                    }
                }, 100);
            }, []);

            if (!user) return <div className="min-h-screen flex flex-col items-center justify-center text-indigo-400 font-bold animate-pulse text-lg tracking-tight">กำลังเชื่อมต่อ...</div>;

            return (
                <div className="min-h-screen flex flex-col bg-[#171717]">
                    {screen === 'hub' && (
                        <div className="flex-1 flex flex-col items-center justify-center p-6 animate-slide-up text-center">
                            <h1 className="text-6xl font-black text-gradient mb-12 tracking-tighter">Anime Game Hub</h1>
                            <div className="grid grid-cols-1 sm:grid-cols-3 gap-6 w-full max-w-5xl px-4">
                                <button onClick={() => {setGameType('bingo'); setScreen('lobby');}} className="bg-[#262626] p-10 rounded-[2.5rem] border border-white/5 hover:border-indigo-500/30 transition-all text-left group shadow-xl">
                                    <Icon name="grid" size={40} className="text-indigo-400 mb-6" />
                                    <h3 className="text-2xl font-bold mb-2 text-white">บิงโกกกก</h3>
                                    <p className="text-neutral-500 font-medium text-sm">Random categories challenge.</p>
                                </button>
                                <button onClick={() => {setGameType('yesno'); setScreen('lobby');}} className="bg-[#262626] p-10 rounded-[2.5rem] border border-white/5 hover:border-pink-500/30 transition-all text-left group shadow-xl">
                                    <Icon name="help" size={40} className="text-pink-400 mb-6" />
                                    <h3 className="text-2xl font-bold mb-2 text-white">ทายมาสิน้อง</h3>
                                    <p className="text-neutral-500 font-medium text-sm">Guess the secret character.</p>
                                </button>
                                <button onClick={() => {setGameType('tierlist'); setScreen('lobby');}} className="bg-[#262626] p-10 rounded-[2.5rem] border border-white/5 hover:border-orange-500/30 transition-all text-left group shadow-xl">
                                    <Icon name="layers" size={40} className="text-orange-400 mb-6" />
                                    <h3 className="text-2xl font-bold mb-2 text-white">จัดเทียร์</h3>
                                    <p className="text-neutral-500 font-medium text-sm">Collaborative tier list ranking.</p>
                                </button>
                            </div>
                        </div>
                    )}
                    {screen === 'lobby' && <Lobby fb={fb} appId={appId} gameType={gameType} onBack={() => setScreen('hub')} onJoin={(id) => {setRoomId(id); setScreen('game');}} user={user} playerName={playerName} setPlayerName={setPlayerName} />}
                    {screen === 'game' && gameType === 'bingo' && <BingoGame fb={fb} appId={appId} roomId={roomId} onBack={() => setScreen('hub')} user={user} playerName={playerName} />}
                    {screen === 'game' && gameType === 'yesno' && <GuessingGame fb={fb} appId={appId} roomId={roomId} onBack={() => setScreen('hub')} user={user} playerName={playerName} />}
                    {screen === 'game' && gameType === 'tierlist' && <TierListGame fb={fb} appId={appId} roomId={roomId} onBack={() => setScreen('hub')} user={user} playerName={playerName} />}
                </div>
            );
        }

        function Lobby({ fb, appId, gameType, onBack, onJoin, user, playerName, setPlayerName }) {
            const [roomCode, setRoomCode] = useState('');
            const displayTitles = { bingo: 'บิงโกกกก', yesno: 'ทายมาสิน้อง', tierlist: 'จัดเทียร์' };

            const handleAction = async (isCreate) => {
                if (!playerName.trim()) return;
                const id = isCreate ? Math.random().toString(36).substring(2, 5).toUpperCase() : roomCode.toUpperCase();
                const roomRef = fb.doc(fb.db, 'artifacts', appId, 'public', 'data', 'rooms', id);
                if (isCreate) {
                    const baseData = {
                        gameType, owner: user.uid, players: { [user.uid]: playerName }, playerOrder: [user.uid],
                        createdAt: new Date().toISOString()
                    };
                    if (gameType === 'bingo') {
                        Object.assign(baseData, { grid: Array(9).fill(null), gridSize: 3, topCats: shuffleAndPick(CAT_PHYSICAL, 3), leftCats: shuffleAndPick(CAT_TRAITS, 3), turnUid: user.uid });
                    } else if (gameType === 'tierlist') {
                        Object.assign(baseData, { tierItems: [], tiers: [
                            {id: 'S', label: 'S', color: 'bg-red-500'}, {id: 'A', label: 'A', color: 'bg-orange-500'}, 
                            {id: 'B', label: 'B', color: 'bg-yellow-500'}, {id: 'C', label: 'C', color: 'bg-green-500'},
                            {id: 'D', label: 'D', color: 'bg-blue-500'}
                        ] });
                    }
                    await fb.setDoc(roomRef, baseData);
                    onJoin(id);
                } else {
                    const snap = await fb.getDoc(roomRef);
                    if (snap.exists()) {
                        const data = snap.data();
                        const newOrder = data.playerOrder || [];
                        if (!newOrder.includes(user.uid)) newOrder.push(user.uid);
                        await fb.updateDoc(roomRef, { [`players.${user.uid}`]: playerName, playerOrder: newOrder });
                        onJoin(id);
                    } else { alert("Room not found"); }
                }
            };
            return (
                <div className="flex-1 flex flex-col items-center justify-center p-6 animate-slide-up">
                    <div className="w-full max-w-md bg-[#262626] p-10 rounded-[2.5rem] border border-white/5 shadow-2xl">
                        <button onClick={onBack} className="text-neutral-500 mb-6 flex items-center font-bold text-sm hover:text-white transition-colors"><Icon name="back" size={16} className="mr-2" /> กลับหน้าหลัก</button>
                        <h2 className="text-3xl font-black mb-8 text-center text-gradient uppercase">ห้อง {displayTitles[gameType]}</h2>
                        <div className="space-y-6">
                            <input value={playerName} onChange={e => {setPlayerName(e.target.value); localStorage.setItem('anime_player_name', e.target.value);}} className="w-full bg-[#1a1a1a] border border-white/5 rounded-2xl px-6 py-4 text-white font-bold focus:outline-none" placeholder="ใส่ชื่อเล่นของคุณ" />
                            <button onClick={() => handleAction(true)} className="w-full btn-primary py-4 rounded-2xl font-bold shadow-lg">สร้างห้องใหม่</button>
                            <div className="flex gap-2">
                                <input value={roomCode} onChange={e => setRoomCode(e.target.value)} className="flex-1 bg-[#1a1a1a] border border-white/5 rounded-2xl px-6 py-4 text-white font-mono uppercase focus:outline-none" placeholder="รหัสห้อง" />
                                <button onClick={() => handleAction(false)} className="bg-[#333] px-6 rounded-2xl font-bold transition-all hover:bg-[#444]">เข้าร่วม</button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        function BingoGame({ fb, appId, roomId, onBack, user, playerName }) {
            const [grid, setGrid] = useState([]);
            const [gridSize, setGridSize] = useState(3);
            const [topCats, setTopCats] = useState([]);
            const [leftCats, setLeftCats] = useState([]);
            const [turnUid, setTurnUid] = useState(null);
            const [winnerUid, setWinnerUid] = useState(null);
            const [activeCell, setActiveCell] = useState(null);
            const [search, setSearch] = useState('');
            const [searchType, setSearchType] = useState('anime');
            const [results, setResults] = useState([]);
            const [searching, setSearching] = useState(false);
            const [players, setPlayers] = useState({});
            const [owner, setOwner] = useState(null);

            useEffect(() => {
                const roomRef = fb.doc(fb.db, 'artifacts', appId, 'public', 'data', 'rooms', roomId);
                return fb.onSnapshot(roomRef, (snap) => {
                    if (snap.exists()) {
                        const d = snap.data();
                        setGrid(d.grid || Array((d.gridSize || 3)**2).fill(null));
                        setGridSize(d.gridSize || 3);
                        setTopCats(d.topCats || []);
                        setLeftCats(d.leftCats || []);
                        setTurnUid(d.turnUid);
                        setWinnerUid(d.winnerUid);
                        setPlayers(d.players || {});
                        setOwner(d.owner || null);
                    }
                });
            }, []);

            useEffect(() => {
                if (search.trim().length > 0) {
                    const timer = setTimeout(async () => {
                        setSearching(true);
                        try {
                            const url = searchType === 'anime' ? `https://api.jikan.moe/v4/anime?q=${encodeURIComponent(search)}&limit=12` : `https://api.jikan.moe/v4/characters?q=${encodeURIComponent(search)}&limit=12`;
                            const r = await fetch(url);
                            const d = await r.json();
                            setResults(d.data?.map(m => ({ id: m.mal_id, title: m.title_english || m.title || m.name, image: m.images.webp.large_image_url || m.images.webp.image_url })) || []);
                        } catch(e) {} finally { setSearching(false); }
                    }, 500);
                    return () => clearTimeout(timer);
                } else setResults([]);
            }, [search, searchType]);

            const checkWin = (g, s) => {
                const line = (a, b, c) => g[a] && g[b] && g[c] && g[a].uid === g[b].uid && g[b].uid === g[c].uid;
                for (let r = 0; r < s; r++) for (let c = 0; c <= s - 3; c++) if (line(r * s + c, r * s + c + 1, r * s + c + 2)) return true;
                for (let c = 0; c < s; c++) for (let r = 0; r <= s - 3; r++) if (line(r * s + c, (r + 1) * s + c, (r + 2) * s + c)) return true;
                for (let r = 0; r <= s - 3; r++) for (let c = 0; c <= s - 3; c++) if (line(r * s + c, (r + 1) * s + c + 1, (r + 2) * s + c + 2)) return true;
                for (let r = 0; r <= s - 3; r++) for (let c = 2; c < s; c++) if (line(r * s + c, (r + 1) * s + c - 1, (r + 2) * s + c - 2)) return true;
                return false;
            };

            const selectItem = async (item) => {
                if (activeCell === null) return;
                const roomRef = fb.doc(fb.db, 'artifacts', appId, 'public', 'data', 'rooms', roomId);
                const snap = await fb.getDoc(roomRef);
                if (!snap.exists()) return;
                const d = snap.data();
                const latestGrid = [...(d.grid || Array(gridSize * gridSize).fill(null))];
                const order = d.playerOrder || [];
                latestGrid[activeCell] = { title: item.title, image: item.image || null, uid: user.uid, by: playerName || 'Anonymous' };
                const won = checkWin(latestGrid, gridSize);
                const nextTurn = order[(order.indexOf(user.uid) + 1) % order.length];
                await fb.updateDoc(roomRef, { grid: latestGrid, turnUid: won ? user.uid : nextTurn, winnerUid: won ? user.uid : null });
                setActiveCell(null); setSearch('');
            };

            const isTurn = user.uid === turnUid;

            return (
                <div className="flex-1 p-6 flex flex-col items-center animate-slide-up">
                    <div className="w-full max-w-5xl flex justify-between items-center mb-8">
                        <button onClick={onBack} className="text-neutral-500 font-bold flex items-center hover:text-white transition-colors"><Icon name="back" className="mr-2" /> Exit</button>
                        <div className="flex gap-4">
                            <div className={`px-6 py-3 rounded-2xl border font-bold transition-all ${isTurn && !winnerUid ? 'bg-indigo-600 text-white shadow-lg' : 'bg-[#262626] text-neutral-500 border-white/5'}`}>
                                {isTurn ? 'YOUR TURN' : players[turnUid] ? `${players[turnUid].toUpperCase()}'S TURN` : 'WAITING...'}
                            </div>
                            <div className="bg-indigo-600/20 px-6 py-3 rounded-2xl font-mono text-indigo-400 font-bold tracking-widest border border-indigo-500/20 uppercase">Room: {roomId}</div>
                        </div>
                    </div>
                    <div className="bg-[#262626] p-4 md:p-8 rounded-[3rem] border border-white/5 w-full max-w-4xl overflow-x-auto shadow-2xl custom-scrollbar">
                        <div className={`grid grid-cols-${gridSize+1} gap-2 md:gap-4 min-w-[500px]`}>
                            <div className="aspect-square"></div>
                            {topCats.slice(0, gridSize).map((c, i) => <div key={i} className="aspect-square bg-indigo-900/30 rounded-2xl flex items-center justify-center p-3 text-center font-black text-indigo-300 text-xs md:text-xl leading-tight border border-indigo-500/10 shadow-inner uppercase">{c}</div>)}
                            {leftCats.slice(0, gridSize).map((lc, r) => (
                                <Fragment key={r}>
                                    <div className="aspect-square bg-pink-900/30 rounded-2xl flex items-center justify-center p-3 text-center font-black text-pink-300 text-xs md:text-xl leading-tight border border-pink-500/10 shadow-inner uppercase">{lc}</div>
                                    {Array.from({length: gridSize}).map((_, c) => {
                                        const idx = r * gridSize + c;
                                        const cell = grid[idx];
                                        const isMine = cell && cell.uid === user.uid;
                                        return (
                                            <button key={c} disabled={!isTurn || !!cell || winnerUid} onClick={() => setActiveCell(idx)} className={`aspect-square rounded-2xl overflow-hidden relative flex items-center justify-center transition-all ${cell ? (isMine ? 'border-4 border-green-500' : 'border-4 border-pink-500') : 'bg-[#1a1a1a] hover:bg-indigo-500/10 shadow-inner border border-white/5'}`}>
                                                {cell ? <img src={cell.image} className="w-full h-full object-cover" /> : (isTurn && !winnerUid && <div className="text-indigo-500/20 text-4xl font-black">+</div>)}
                                                {cell && <div className="absolute top-1 right-1 bg-black/60 text-[8px] px-2 py-0.5 rounded text-white font-black uppercase">{cell.by}</div>}
                                            </button>
                                        );
                                    })}
                                </Fragment>
                            ))}
                        </div>
                    </div>
                    {winnerUid && (
                        <div className="fixed inset-0 z-50 bg-black/80 backdrop-blur-xl flex flex-col items-center justify-center p-6 text-center">
                            <Icon name="trophy" size={120} className="text-yellow-400 mb-8 animate-victory mx-auto" />
                            <h2 className="text-8xl font-black text-white mb-4 uppercase">BINGO!</h2>
                            <p className="text-3xl text-indigo-400 font-bold mb-12">{players[winnerUid]} WON THE GAME</p>
                            <button onClick={onBack} className="btn-primary px-12 py-5 rounded-3xl font-black text-xl">Back to Hub</button>
                        </div>
                    )}
                    {activeCell !== null && (
                        <div className="fixed inset-0 z-[100] flex items-center justify-center p-4 bg-black/90 backdrop-blur-md">
                            <div className="w-full max-w-xl bg-[#262626] rounded-[3rem] h-[80vh] flex flex-col animate-slide-up shadow-2xl overflow-hidden border border-white/5">
                                <div className="p-8 border-b border-white/5 flex justify-between items-center bg-[#2a2a2a]">
                                    <h3 className="text-2xl font-bold">Select Item</h3>
                                    <button onClick={() => setActiveCell(null)} className="text-neutral-500 hover:text-white transition-colors"><Icon name="close" /></button>
                                </div>
                                <div className="flex border-b border-white/5 font-black bg-[#1a1a1a]">
                                    <button onClick={() => setSearchType('anime')} className={`flex-1 py-5 transition-all ${searchType === 'anime' ? 'text-indigo-400 border-b-2 border-indigo-400 bg-indigo-400/5' : 'text-neutral-500'}`}>Anime</button>
                                    <button onClick={() => setSearchType('character')} className={`flex-1 py-5 transition-all ${searchType === 'character' ? 'text-pink-400 border-b-2 border-pink-400 bg-pink-500/5' : 'text-neutral-500'}`}>Character</button>
                                </div>
                                <div className="flex-1 overflow-y-auto p-8 custom-scrollbar">
                                    <input autoFocus value={search} onChange={e => setSearch(e.target.value)} className="w-full bg-[#1a1a1a] border border-white/5 rounded-2xl p-5 mb-6 text-white font-bold outline-none" placeholder="Search..." />
                                    <div className="grid grid-cols-2 gap-4">
                                        {searching && <div className="col-span-2 text-center text-indigo-400 animate-pulse font-black py-10 uppercase tracking-widest">SEARCHING...</div>}
                                        {results.map(item => (
                                            <button key={item.id} onClick={() => selectItem(item)} className="text-left group animate-slide-up">
                                                <div className="aspect-[3/4] rounded-xl overflow-hidden mb-2 bg-[#1a1a1a] group-hover:border-indigo-500/50 border border-white/5"><img src={item.image} className="w-full h-full object-cover group-hover:scale-105 transition-transform" /></div>
                                                <p className="text-sm font-bold text-neutral-400 group-hover:text-white line-clamp-2">{item.title}</p>
                                            </button>
                                        ))}
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        // --- YES/NO GUESSING ---
        function GuessingGame({ fb, appId, roomId, onBack, user, playerName }) {
            const [roomData, setRoomData] = useState(null);
            const [search, setSearch] = useState('');
            const [searchType, setSearchType] = useState('anime');
            const [results, setResults] = useState([]);
            const [picking, setPicking] = useState(false);
            const [searching, setSearching] = useState(false);

            useEffect(() => {
                const roomRef = fb.doc(fb.db, 'artifacts', appId, 'public', 'data', 'rooms', roomId);
                return fb.onSnapshot(roomRef, (snap) => { if (snap.exists()) setRoomData(snap.data()); });
            }, []);

            useEffect(() => {
                if (search.trim()) {
                    const t = setTimeout(async () => {
                        setSearching(true);
                        try {
                            const url = searchType === 'anime' ? `https://api.jikan.moe/v4/anime?q=${encodeURIComponent(search)}&limit=10` : `https://api.jikan.moe/v4/characters?q=${encodeURIComponent(search)}&limit=10`;
                            const r = await fetch(url);
                            const d = await r.json();
                            setResults(d.data?.map(m => ({ title: m.title_english || m.title || m.name, image: m.images.webp.large_image_url || m.images.webp.image_url })) || []);
                        } catch(e) {} finally { setSearching(false); }
                    }, 500);
                    return () => clearTimeout(t);
                } else setResults([]);
            }, [search, searchType]);

            const setSecret = async (item) => {
                const roomRef = fb.doc(fb.db, 'artifacts', appId, 'public', 'data', 'rooms', roomId);
                await fb.updateDoc(roomRef, { [`secrets.${user.uid}`]: { title: item.title, image: item.image || null }, [`reveals.${user.uid}`]: false });
                setPicking(false); setSearch('');
            };

            const revealMyAnswer = async () => {
                const roomRef = fb.doc(fb.db, 'artifacts', appId, 'public', 'data', 'rooms', roomId);
                await fb.updateDoc(roomRef, { [`reveals.${user.uid}`]: true });
            };

            if (!roomData) return null;

            return (
                <div className="flex-1 p-6 flex flex-col items-center animate-slide-up">
                    <div className="w-full max-w-4xl flex justify-between items-center mb-10">
                        <button onClick={onBack} className="text-neutral-500 font-bold flex items-center hover:text-white transition-colors"><Icon name="back" className="mr-2" /> Exit</button>
                        <div className="bg-pink-600/20 px-8 py-4 rounded-3xl font-mono text-pink-400 font-black tracking-widest border border-pink-500/20 shadow-inner uppercase">Guessing Mode</div>
                    </div>
                    <div className="w-full max-w-4xl grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div className="bg-[#262626] p-8 rounded-[3rem] border border-white/5 shadow-2xl flex flex-col items-center text-center">
                            <h3 className="text-lg font-black text-neutral-500 mb-6 uppercase tracking-[0.2em]">Your Secret</h3>
                            {roomData.secrets?.[user.uid] ? (
                                <div className="w-full space-y-6">
                                    <div className="bg-indigo-500/10 border-2 border-indigo-500/30 p-8 rounded-[2rem] w-full relative">
                                        {roomData.secrets[user.uid].image && <img src={roomData.secrets[user.uid].image} className="w-24 h-32 object-cover rounded-2xl mx-auto mb-4 border border-indigo-500/30" />}
                                        <p className="text-3xl font-black text-indigo-400 mb-2 leading-tight">{roomData.secrets[user.uid].title}</p>
                                    </div>
                                    {!roomData.reveals?.[user.uid] && <button onClick={revealMyAnswer} className="w-full py-5 bg-red-600/20 text-red-400 border border-red-500/30 rounded-2xl font-black text-xl hover:bg-red-600 hover:text-white transition-all">Reveal My Answer</button>}
                                </div>
                            ) : (
                                <button onClick={() => setPicking(true)} className="w-full py-10 border-4 border-dashed border-white/5 rounded-[2rem] text-indigo-400 font-black text-2xl hover:bg-indigo-500/5 transition-all">Set Secret</button>
                            )}
                        </div>
                        <div className="bg-[#262626] p-8 rounded-[3rem] border border-white/5 shadow-2xl">
                            <h3 className="text-lg font-black text-neutral-500 mb-6 uppercase tracking-[0.2em]">Other Players</h3>
                            <div className="space-y-4 max-h-[50vh] overflow-y-auto custom-scrollbar pr-2">
                                {Object.entries(roomData.players).map(([uid, name]) => {
                                    const secret = roomData.secrets?.[uid];
                                    const revealed = roomData.reveals?.[uid];
                                    return (
                                        <div key={uid} className={`p-5 rounded-2xl border transition-all ${secret ? 'bg-indigo-500/5 border-indigo-500/20' : 'bg-[#1a1a1a] border-white/5'}`}>
                                            <div className="flex justify-between items-center">
                                                <span className="font-black text-lg">{name}</span>
                                                {revealed && <span className="text-[10px] bg-pink-500 text-white px-2 py-0.5 rounded-full font-black uppercase tracking-tighter">REVEALED</span>}
                                            </div>
                                            {revealed && secret && (
                                                <div className="mt-4 pt-4 border-t border-white/5 text-center flex flex-col items-center">
                                                    {secret.image && <img src={secret.image} className="w-20 h-28 object-cover rounded-xl mb-3" />}
                                                    <p className="text-2xl font-black text-white leading-tight">{secret.title}</p>
                                                </div>
                                            )}
                                        </div>
                                    );
                                })}
                            </div>
                        </div>
                    </div>
                    {picking && (
                        <div className="fixed inset-0 z-[120] flex items-center justify-center p-4 bg-black/95 backdrop-blur-md">
                            <div className="w-full max-w-xl bg-[#262626] rounded-[3rem] h-[85vh] flex flex-col animate-slide-up shadow-2xl overflow-hidden border border-white/5">
                                <div className="p-8 border-b border-white/5 flex justify-between items-center bg-[#2a2a2a]">
                                    <h3 className="text-3xl font-black text-white">Pick Character</h3>
                                    <button onClick={() => setPicking(false)}><Icon name="close" /></button>
                                </div>
                                <div className="flex border-b border-white/5 font-black bg-[#1a1a1a]">
                                    <button onClick={() => setSearchType('anime')} className={`flex-1 py-5 transition-all ${searchType === 'anime' ? 'text-indigo-400 border-b-2 border-indigo-400 bg-indigo-400/5' : 'text-neutral-500'}`}>Anime</button>
                                    <button onClick={() => setSearchType('character')} className={`flex-1 py-5 transition-all ${searchType === 'character' ? 'text-pink-400 border-b-2 border-pink-400 bg-pink-500/5' : 'text-neutral-500'}`}>Character</button>
                                </div>
                                <div className="flex-1 overflow-y-auto p-8 custom-scrollbar">
                                    <input autoFocus value={search} onChange={e => setSearch(e.target.value)} className="w-full bg-[#1a1a1a] border border-white/5 rounded-2xl p-5 mb-6 text-white font-bold outline-none" placeholder="Search..." />
                                    {searching && <div className="text-center text-indigo-400 font-black py-4 uppercase">Searching...</div>}
                                    <div className="space-y-2">
                                        {results.map((r, i) => (
                                            <button key={i} onClick={() => setSecret(r)} className="w-full text-left p-5 bg-[#1a1a1a] hover:bg-indigo-500/10 rounded-2xl font-bold transition-all border border-white/5 flex items-center gap-4 group">
                                                <img src={r.image} className="w-12 h-16 object-cover rounded-lg group-hover:scale-105 transition-transform" />
                                                <span className="flex-1 line-clamp-1">{r.title}</span>
                                            </button>
                                        ))}
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        // --- TIER LIST GAME ---
        function TierListGame({ fb, appId, roomId, onBack, user, playerName }) {
            const [roomData, setRoomData] = useState(null);
            const [search, setSearch] = useState('');
            const [searchType, setSearchType] = useState('character');
            const [results, setResults] = useState([]);
            const [searching, setSearching] = useState(false);
            const [adding, setAdding] = useState(false);
            const [bulkLoadingId, setBulkLoadingId] = useState(null);

            useEffect(() => {
                const roomRef = fb.doc(fb.db, 'artifacts', appId, 'public', 'data', 'rooms', roomId);
                return fb.onSnapshot(roomRef, (snap) => { if (snap.exists()) setRoomData(snap.data()); });
            }, []);

            useEffect(() => {
                if (search.trim()) {
                    const t = setTimeout(async () => {
                        setSearching(true);
                        try {
                            const url = searchType === 'anime' ? `https://api.jikan.moe/v4/anime?q=${encodeURIComponent(search)}&limit=10` : `https://api.jikan.moe/v4/characters?q=${encodeURIComponent(search)}&limit=10`;
                            const r = await fetch(url);
                            const d = await r.json();
                            setResults(d.data?.map(m => ({ 
                                id: m.mal_id, 
                                title: m.title_english || m.title || m.name, 
                                image: m.images?.webp?.large_image_url || m.images?.webp?.image_url 
                            })) || []);
                        } catch(e) {} finally { setSearching(false); }
                    }, 500);
                    return () => clearTimeout(t);
                } else setResults([]);
            }, [search, searchType]);

            const addItem = async (item) => {
                const roomRef = fb.doc(fb.db, 'artifacts', appId, 'public', 'data', 'rooms', roomId);
                const newItem = { ...item, instanceId: Math.random().toString(36).substring(7), tier: 'unranked' };
                await fb.updateDoc(roomRef, { tierItems: fb.arrayUnion(newItem) });
                if (!bulkLoadingId) { setAdding(false); setSearch(''); }
            };

            const addAllCharactersFromAnime = async (animeId) => {
                setBulkLoadingId(animeId);
                try {
                    const res = await fetch(`https://api.jikan.moe/v4/anime/${animeId}/characters`);
                    const data = await res.json();
                    if (data.data) {
                        const roomRef = fb.doc(fb.db, 'artifacts', appId, 'public', 'data', 'rooms', roomId);
                        const newCharacters = data.data
                            .filter(c => c.role === 'Main' || c.role === 'Supporting')
                            .slice(0, 15) // Limit to top 15 characters to avoid clutter
                            .map(c => ({
                                id: c.character.mal_id,
                                title: c.character.name,
                                image: c.character.images.webp.image_url,
                                instanceId: Math.random().toString(36).substring(7),
                                tier: 'unranked'
                            }));
                        
                        // Using current data to append to avoid arrayUnion limitations with non-identical objects
                        const currentItems = roomData.tierItems || [];
                        await fb.updateDoc(roomRef, { tierItems: [...currentItems, ...newCharacters] });
                        setAdding(false);
                        setSearch('');
                    }
                } catch(e) { console.error(e); } finally { setBulkLoadingId(null); }
            };

            const updateItemTier = async (instanceId, newTier) => {
                const roomRef = fb.doc(fb.db, 'artifacts', appId, 'public', 'data', 'rooms', roomId);
                const updatedItems = roomData.tierItems.map(item => item.instanceId === instanceId ? { ...item, tier: newTier } : item);
                await fb.updateDoc(roomRef, { tierItems: updatedItems });
            };

            const removeItem = async (instanceId) => {
                const roomRef = fb.doc(fb.db, 'artifacts', appId, 'public', 'data', 'rooms', roomId);
                const filtered = roomData.tierItems.filter(item => item.instanceId !== instanceId);
                await fb.updateDoc(roomRef, { tierItems: filtered });
            };

            if (!roomData) return null;

            const tiers = roomData.tiers || [];
            const tierItems = roomData.tierItems || [];

            return (
                <div className="flex-1 p-6 flex flex-col items-center animate-slide-up">
                    <div className="w-full max-w-6xl flex justify-between items-center mb-8">
                        <button onClick={onBack} className="text-neutral-500 font-bold flex items-center hover:text-white transition-colors"><Icon name="back" className="mr-2" /> Exit</button>
                        <div className="flex gap-4">
                            <button onClick={() => setAdding(true)} className="bg-orange-600 text-white px-6 py-3 rounded-2xl font-bold flex items-center hover:bg-orange-700 transition-all shadow-lg"><Icon name="sparkles" size={18} className="mr-2" /> Add Character</button>
                            <div className="bg-orange-600/20 px-6 py-3 rounded-2xl font-mono text-orange-400 font-bold border border-orange-500/20 shadow-inner uppercase">Room: {roomId}</div>
                        </div>
                    </div>

                    <div className="w-full max-w-6xl space-y-4">
                        {tiers.map(tier => (
                            <div key={tier.id} className="flex bg-[#262626] rounded-2xl overflow-hidden border border-white/5 shadow-xl group">
                                <div className={`${tier.color} w-24 flex items-center justify-center text-4xl font-black text-black/60 shadow-inner`}>{tier.label}</div>
                                <div className="flex-1 p-4 flex flex-wrap gap-4 tier-row">
                                    {tierItems.filter(i => i.tier === tier.id).map(item => (
                                        <div key={item.instanceId} className="relative group/item animate-slide-up">
                                            <img src={item.image} className="w-20 h-28 object-cover rounded-xl shadow-lg border border-white/5" />
                                            <div className="absolute inset-0 bg-black/60 opacity-0 group-hover/item:opacity-100 transition-opacity flex flex-col items-center justify-center gap-2 rounded-xl">
                                                <button onClick={() => updateItemTier(item.instanceId, 'unranked')} className="bg-white text-black p-1 rounded-full"><Icon name="back" size={16} className="rotate-90" /></button>
                                                <button onClick={() => removeItem(item.instanceId)} className="bg-red-500 text-white p-1 rounded-full"><Icon name="close" size={16} /></button>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        ))}
                    </div>

                    <div className="w-full max-w-6xl mt-12">
                        <h3 className="text-xl font-bold text-neutral-500 mb-6 uppercase tracking-widest border-b border-white/5 pb-4">Unranked Pool</h3>
                        <div className="flex flex-wrap gap-6 min-h-[150px] p-8 bg-[#1a1a1a] rounded-[3rem] border border-white/5 shadow-inner">
                            {tierItems.filter(i => i.tier === 'unranked').map(item => (
                                <div key={item.instanceId} className="relative group/item cursor-pointer animate-slide-up">
                                    <img src={item.image} className="w-24 h-32 object-cover rounded-2xl shadow-xl border border-white/5 group-hover:scale-105 transition-transform" />
                                    <p className="text-[10px] text-center mt-2 font-bold text-neutral-500 line-clamp-1 w-24">{item.title}</p>
                                    <div className="absolute inset-0 bg-black/80 opacity-0 group-hover/item:opacity-100 transition-opacity flex flex-wrap content-center justify-center gap-1 rounded-2xl p-2">
                                        {tiers.map(t => (
                                            <button key={t.id} onClick={(e) => { e.stopPropagation(); updateItemTier(item.instanceId, t.id); }} className={`${t.color} text-black text-xs font-black p-2 rounded min-w-[30px] active:scale-95`}>{t.id}</button>
                                        ))}
                                        <button onClick={(e) => { e.stopPropagation(); removeItem(item.instanceId); }} className="bg-red-500 p-2 rounded"><Icon name="close" size={12} /></button>
                                    </div>
                                </div>
                            ))}
                            {tierItems.filter(i => i.tier === 'unranked').length === 0 && (
                                <div className="w-full flex flex-col items-center justify-center text-neutral-600 italic py-10">No unranked items. Add more or move them back here.</div>
                            )}
                        </div>
                    </div>

                    {adding && (
                        <div className="fixed inset-0 z-[120] flex items-center justify-center p-4 bg-black/95 backdrop-blur-md">
                            <div className="w-full max-w-xl bg-[#262626] rounded-[3rem] h-[85vh] flex flex-col animate-slide-up shadow-2xl overflow-hidden border border-white/5">
                                <div className="p-8 border-b border-white/5 flex justify-between items-center bg-[#2a2a2a]">
                                    <h3 className="text-3xl font-black text-white">Add Character</h3>
                                    <button onClick={() => setAdding(false)}><Icon name="close" className="text-neutral-500 hover:text-white" /></button>
                                </div>
                                <div className="flex border-b border-white/5 font-black bg-[#1a1a1a]">
                                    <button onClick={() => setSearchType('anime')} className={`flex-1 py-5 transition-all ${searchType === 'anime' ? 'text-indigo-400 border-b-2 border-indigo-400 bg-indigo-400/5' : 'text-neutral-500'}`}>Anime</button>
                                    <button onClick={() => setSearchType('character')} className={`flex-1 py-5 transition-all ${searchType === 'character' ? 'text-pink-400 border-b-2 border-pink-400 bg-pink-500/5' : 'text-neutral-500'}`}>Character</button>
                                </div>
                                <div className="flex-1 overflow-y-auto p-8 custom-scrollbar">
                                    <input autoFocus value={search} onChange={e => setSearch(e.target.value)} className="w-full bg-[#1a1a1a] border border-white/5 rounded-2xl p-6 mb-6 text-white font-bold outline-none focus:ring-2 focus:ring-orange-500/30" placeholder={searchType === 'anime' ? "Search anime to get characters..." : "Search characters to add..."} />
                                    {searching && <div className="text-center text-orange-400 font-black py-4 uppercase">Searching...</div>}
                                    <div className="grid grid-cols-2 gap-4">
                                        {results.map((r, i) => (
                                            <div key={i} className="text-left group animate-slide-up bg-[#1a1a1a] p-3 rounded-2xl border border-white/5 hover:border-orange-500/30 transition-all">
                                                <div className="aspect-[3/4] rounded-xl overflow-hidden mb-3 bg-[#171717] border border-white/5"><img src={r.image} className="w-full h-full object-cover group-hover:scale-105 transition-transform" /></div>
                                                <p className="text-xs font-bold text-neutral-400 group-hover:text-white line-clamp-1 mb-3">{r.title}</p>
                                                {searchType === 'anime' ? (
                                                    <button 
                                                        onClick={() => addAllCharactersFromAnime(r.id)} 
                                                        disabled={bulkLoadingId === r.id}
                                                        className="w-full py-2 bg-indigo-600 hover:bg-indigo-700 disabled:bg-neutral-700 rounded-xl text-[10px] font-black uppercase flex items-center justify-center gap-2"
                                                    >
                                                        {bulkLoadingId === r.id ? 'Loading...' : <Fragment><Icon name="download" size={14} /> Add All Characters</Fragment>}
                                                    </button>
                                                ) : (
                                                    <button onClick={() => addItem(r)} className="w-full py-2 bg-orange-600 hover:bg-orange-700 rounded-xl text-[10px] font-black uppercase">Add to Pool</button>
                                                )}
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        const root = document.getElementById('root');
        ReactDOM.createRoot(root).render(<App />);
    </script>
</body>
</html>

