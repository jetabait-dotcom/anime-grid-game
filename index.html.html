<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Anime Game Hub - ศูนย์รวมเกมอนิเมะ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Anuphan:wght@300;400;500;600;700;800&display=swap');
        body { 
            background-color: #171717; 
            color: #f5f5f5; 
            font-family: 'Anuphan', sans-serif; 
            margin: 0; 
            overflow-x: hidden; 
            line-height: 1.6;
        }
        .text-gradient { background: linear-gradient(to right, #a78bfa, #f472b6); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .btn-primary { background-color: #4f46e5; transition: all 0.2s; }
        .thai-header { letter-spacing: 0.02em; line-height: 1.3; font-weight: 800; }
        .btn-primary:hover { background-color: #4338ca; transform: translateY(-1px); }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .animate-slide-up { animation: slideUp 0.4s ease-out forwards; }
        @keyframes crownBounce { 0%, 100% { transform: translateY(0) rotate(0); } 50% { transform: translateY(-10px) rotate(5deg); } }
        .animate-victory { animation: crownBounce 2s infinite ease-in-out; }
        .tier-row { min-height: 120px; transition: all 0.2s; position: relative; }
        .drag-over { background-color: rgba(79, 70, 229, 0.1) !important; border: 2px dashed #4f46e5 !important; }
        .item-drag-target { border-left: 4px solid #4f46e5 !important; margin-left: -2px; }
    </style>
</head>
<body class="bg-[#171717]">
    <div id="root"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, updateDoc, onSnapshot, collection, arrayUnion } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDy3A8XwrKA-BXjlueZzzTa5BQ1R1SFVzk",
            authDomain: "game-hub-jetabait.firebaseapp.com",
            projectId: "game-hub-jetabait",
            storageBucket: "game-hub-jetabait.firebasestorage.app",
            messagingSenderId: "788930921640",
            appId: "1:788930921640:web:f54c7d47012b4f50a0ee9d",
            measurementId: "G-TL5GQ6BX61"
        };

        try {
            const app = initializeApp(firebaseConfig);
            const auth = getAuth(app);
            const db = getFirestore(app);
            window.FirebaseSDK = { auth, db, doc, setDoc, getDoc, updateDoc, onSnapshot, collection, signInAnonymously, signInWithCustomToken, onAuthStateChanged, arrayUnion };
        } catch (e) { console.error("Firebase Error", e); }
    </script>

    <script type="text/babel">
        const { useState, useEffect, useRef, Fragment } = React;

        const Icon = ({ name, size = 24, className = "" }) => {
            const icons = {
                gamepad: <path d="M6 12h4m-2-2v4m7-1h.01m2.99-2h.01M2 6a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V6Z"/>,
                grid: <path d="M3 3h7v7H3V3Zm11 0h7v7h-7V3ZM3 14h7v7H3v-7Zm11 0h7v7h-7v-7Z"/>,
                back: <path d="m15 18-6-6 6-6"/>,
                users: <Fragment><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></Fragment>,
                user: <Fragment><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></Fragment>,
                search: <Fragment><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></Fragment>,
                close: <path d="M18 6 6 18M6 6l12 12"/>,
                check: <path d="M20 6 9 17l-5-5"/>,
                playCircle: <Fragment><circle cx="12" cy="12" r="10"/><polygon points="10 8 16 12 10 16 10 8"/></Fragment>,
                help: <Fragment><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><line x1="12" y1="17" x2="12.01" y2="17"/></Fragment>,
                sparkles: <path d="m12 3 1.912 5.885L20 10.8l-5.088 1.915L12 18.6l-1.912-5.885L5 10.8l5.088-1.915L12 3Z"/>,
                trophy: <path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6M18 9h1.5a2.5 2.5 0 0 0 0-5H18M4 22h16M10 14.66V17c0 .55.45 1 1 1h2c.55 0 1-.45 1-1v-2.34c3.12-.5 5-2.66 5-5.66V2H6v7c0 3 1.88 5.16 5 5.66z"/>,
                layers: <path d="m12.89 1.45 8 4.61a2 2 0 0 1 0 3.47l-8 4.61a2 2 0 0 1-2 0l-8-4.61a2 2 0 0 1 0-3.47l8-4.61a2 2 0 0 1 2 0z M2.11 12.57l8 4.61a2 2 0 0 0 2 0l8-4.61 M2.11 16.57l8 4.61a2 2 0 0 0 2 0l8-4.61" />,
                trash: <path d="M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2M10 11v6M14 11v6" />,
                book: <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20M4 19.5A2.5 2.5 0 0 0 6.5 22H20V5H6.5A2.5 2.5 0 0 0 4 7.5v12z" />
            };
            return (
                <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                    {icons[name]}
                </svg>
            );
        };

        const CAT_PHYSICAL = ["ผู้หญิง", "ผู้ชาย", "ผมชมพู", "ผมสองสี", "ผมส้ม", "ผมน้ำตาล", "ผมเทา", "ผมขาว", "ผมฟ้า", "ผมบลอนด์", "ผมเขียว", "ผมแดง", "ผมม่วง", "ผมสั้น", "ผมยาว", "หัวโล้น", "ผ้าปิดตา", "รอยสัก", "แผลเป็น", "แว่นตา", "หมวก", "หน้ากาก", "ผ้าคลุม", "ผ้าพันคอ", "ชุดสูท", "ปีก", "หาง", "เขี้ยว", "เขา", "กล้ามเนื้อ", "หุ่นยนต์", "ไซบอร์ก", "ผิวแทน", "ผู้สูงอายุ", "เด็ก", "อมนุษย์", "นักเรียน"];
        const CAT_TRAITS = ["พลังไฟ", "พลังน้ำ", "พลังสายฟ้า", "พลังน้ำแข็ง", "พลังจิต", "แปลงร่าง", "พระเอก/นางเอก", "ตัวร้าย", "นางเอก (Heroine)", "ตัวตลก", "คล้ายสัตว์", "พระเจ้า", "ปีศาจ", "แวมไพร์", "เอลฟ์", "เอเลี่ยน", "อาจารย์", "ผู้ใช้ดาบ", "ผู้ใช้ปืน", "นักเวทย์", "อัศวิน", "ไอดอล", "นักดนตรี", "ราชวงศ์", "เมด/พ่อบ้าน", "ยากูซ่า", "โจรสลัด", "นินจา", "เชฟ", "คุณหมอ", "นักสืบ", "สายลับ", "พี่น้อง", "เจ้าของสัตว์เลี้ยง", "ต่างโลก (Isekai)", "ระทึกขวัญ", "ชีวิตประจำวัน", "โรงเรียน", "ตลก", "โรแมนติก", "ไซไฟ", "ปริศนา", "สยองขวัญ", "กีฬา", "โลกอนาคต", "ฮาเร็ม", "ดราม่า"];

        const shuffleAndPick = (arr, count) => [...arr].sort(() => Math.random() - 0.5).slice(0, count);

        function App() {
            const [screen, setScreen] = useState('hub');
            const [user, setUser] = useState(null);
            const [fb, setFb] = useState(null);
            const [roomId, setRoomId] = useState('');
            const [gameType, setGameType] = useState('bingo');
            const [playerName, setPlayerName] = useState(localStorage.getItem('anime_player_name') || '');
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'game-hub-jetabait';

            useEffect(() => {
                const check = setInterval(() => {
                    if (window.FirebaseSDK) {
                        clearInterval(check);
                        const sdk = window.FirebaseSDK;
                        setFb(sdk);
                        sdk.onAuthStateChanged(sdk.auth, (u) => { if (u) setUser(u); });
                        const initAuth = async () => {
                            try {
                                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                                    await sdk.signInWithCustomToken(sdk.auth, __initial_auth_token);
                                } else {
                                    await sdk.signInAnonymously(sdk.auth);
                                }
                            } catch(e) { await sdk.signInAnonymously(sdk.auth); }
                        };
                        initAuth();
                    }
                }, 100);
            }, []);

            if (!user) return <div className="min-h-screen flex flex-col items-center justify-center text-indigo-400 font-bold animate-pulse text-2xl tracking-tight thai-header">กำลังเชื่อมต่อ...</div>;

            return (
                <div className="min-h-screen flex flex-col bg-[#171717]">
                    {screen === 'hub' && (
                        <div className="flex-1 flex flex-col items-center justify-center p-6 animate-slide-up text-center">
                            <h1 className="text-6xl font-black text-gradient mb-12 tracking-tighter thai-header">Anime Game Hub</h1>
                            <div className="grid grid-cols-1 sm:grid-cols-3 gap-6 w-full max-w-5xl px-4">
                                <button onClick={() => {setGameType('bingo'); setScreen('lobby');}} className="bg-[#262626] p-10 rounded-[2.5rem] border border-white/5 hover:border-indigo-500/30 transition-all text-left group shadow-xl">
                                    <Icon name="grid" size={40} className="text-indigo-400 mb-6" />
                                    <h3 className="text-2xl font-bold mb-2 text-white thai-header">บิงโกกกก</h3>
                                    <p className="text-neutral-500 font-medium text-sm">ท้าทายการสุ่มหมวดหมู่จากอนิเมะ</p>
                                </button>
                                <button onClick={() => {setGameType('yesno'); setScreen('lobby');}} className="bg-[#262626] p-10 rounded-[2.5rem] border border-white/5 hover:border-pink-500/30 transition-all text-left group shadow-xl">
                                    <Icon name="help" size={40} className="text-pink-400 mb-6" />
                                    <h3 className="text-2xl font-bold mb-2 text-white thai-header">ทายมาสิน้อง</h3>
                                    <p className="text-neutral-500 font-medium text-sm">ทายตัวละครลับจากคำถาม ใช่/ไม่ใช่</p>
                                </button>
                                <button onClick={() => {setGameType('tierlist'); setScreen('lobby');}} className="bg-[#262626] p-10 rounded-[2.5rem] border border-white/5 hover:border-orange-500/30 transition-all text-left group shadow-xl">
                                    <Icon name="layers" size={40} className="text-orange-400 mb-6" />
                                    <h3 className="text-2xl font-bold mb-2 text-white thai-header">จัดเทียร์</h3>
                                    <p className="text-neutral-500 font-medium text-sm">จัดอันดับตัวละครร่วมกับเพื่อนๆ</p>
                                </button>
                            </div>
                        </div>
                    )}
                    {screen === 'lobby' && <Lobby fb={fb} appId={appId} gameType={gameType} onBack={() => setScreen('hub')} onJoin={(id) => {setRoomId(id); setScreen('game');}} user={user} playerName={playerName} setPlayerName={setPlayerName} />}
                    {screen === 'game' && gameType === 'bingo' && <BingoGame fb={fb} appId={appId} roomId={roomId} onBack={() => setScreen('hub')} user={user} playerName={playerName} />}
                    {screen === 'game' && gameType === 'yesno' && <GuessingGame fb={fb} appId={appId} roomId={roomId} onBack={() => setScreen('hub')} user={user} playerName={playerName} />}
                    {screen === 'game' && gameType === 'tierlist' && <TierListGame fb={fb} appId={appId} roomId={roomId} onBack={() => setScreen('hub')} user={user} playerName={playerName} />}
                </div>
            );
        }

        function Lobby({ fb, appId, gameType, onBack, onJoin, user, playerName, setPlayerName }) {
            const [roomCode, setRoomCode] = useState('');
            const [gridSize, setGridSize] = useState(3);
            const displayTitles = { bingo: 'บิงโกกกก', yesno: 'ทายมาสิน้อง', tierlist: 'จัดเทียร์' };

            const handleAction = async (isCreate) => {
                if (!playerName.trim()) return;
                const id = isCreate ? Math.random().toString(36).substring(2, 5).toUpperCase() : roomCode.toUpperCase();
                const roomRef = fb.doc(fb.db, 'artifacts', appId, 'public', 'data', 'rooms', id);
                if (isCreate) {
                    const baseData = {
                        gameType, owner: user.uid, players: { [user.uid]: playerName }, playerOrder: [user.uid],
                        createdAt: new Date().toISOString()
                    };
                    if (gameType === 'bingo') {
                        Object.assign(baseData, { 
                            grid: Array(gridSize * gridSize).fill(null), 
                            gridSize: gridSize, 
                            topCats: shuffleAndPick(CAT_PHYSICAL, gridSize), 
                            leftCats: shuffleAndPick(CAT_TRAITS, gridSize), 
                            turnUid: user.uid 
                        });
                    } else if (gameType === 'tierlist') {
                        Object.assign(baseData, { tierItems: [], tiers: [
                            {id: 'S', label: 'S', color: 'bg-red-500'}, {id: 'A', label: 'A', color: 'bg-orange-500'}, 
                            {id: 'B', label: 'B', color: 'bg-yellow-500'}, {id: 'C', label: 'C', color: 'bg-green-500'},
                            {id: 'D', label: 'D', color: 'bg-blue-500'}
                        ] });
                    }
                    await fb.setDoc(roomRef, baseData);
                    onJoin(id);
                } else {
                    const snap = await fb.getDoc(roomRef);
                    if (snap.exists()) {
                        const data = snap.data();
                        const newOrder = data.playerOrder || [];
                        if (!newOrder.includes(user.uid)) newOrder.push(user.uid);
                        await fb.updateDoc(roomRef, { [`players.${user.uid}`]: playerName, playerOrder: newOrder });
                        onJoin(id);
                    } else { alert("ไม่พบห้องที่ระบุ"); }
                }
            };
            return (
                <div className="flex-1 flex flex-col items-center justify-center p-6 animate-slide-up">
                    <div className="w-full max-w-md bg-[#262626] p-10 rounded-[2.5rem] border border-white/5 shadow-2xl">
                        <button onClick={onBack} className="text-neutral-500 mb-6 flex items-center font-bold text-sm hover:text-white transition-colors thai-header"><Icon name="back" size={16} className="mr-2" /> กลับหน้าหลัก</button>
                        <h2 className="text-3xl font-black mb-8 text-center text-gradient uppercase thai-header">ห้อง {displayTitles[gameType]}</h2>
                        <div className="space-y-6">
                            <input value={playerName} onChange={e => {setPlayerName(e.target.value); localStorage.setItem('anime_player_name', e.target.value);}} className="w-full bg-[#1a1a1a] border border-white/5 rounded-2xl px-6 py-4 text-white font-bold focus:outline-none" placeholder="ใส่ชื่อเล่นของคุณ" />
                            <button onClick={() => handleAction(true)} className="w-full btn-primary py-4 rounded-2xl font-bold shadow-lg thai-header text-xl">สร้างห้องใหม่</button>
                            <div className="relative flex items-center py-2">
                                <div className="flex-grow border-t border-white/5"></div>
                                <span className="flex-shrink mx-4 text-neutral-600 text-xs font-bold uppercase thai-header">หรือ</span>
                                <div className="flex-grow border-t border-white/5"></div>
                            </div>
                            <div className="flex gap-2">
                                <input value={roomCode} onChange={e => setRoomCode(e.target.value)} className="flex-1 bg-[#1a1a1a] border border-white/5 rounded-2xl px-6 py-4 text-white font-mono uppercase focus:outline-none" placeholder="รหัสห้อง" />
                                <button onClick={() => handleAction(false)} className="bg-[#333] px-6 rounded-2xl font-bold transition-all hover:bg-[#444] thai-header">เข้าร่วม</button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        // --- BINGO GAME ---
        function BingoGame({ fb, appId, roomId, onBack, user, playerName }) {
            const [grid, setGrid] = useState([]);
            const [gridSize, setGridSize] = useState(3);
            const [topCats, setTopCats] = useState([]);
            const [leftCats, setLeftCats] = useState([]);
            const [turnUid, setTurnUid] = useState(null);
            const [winnerUid, setWinnerUid] = useState(null);
            const [activeCell, setActiveCell] = useState(null);
            const [search, setSearch] = useState('');
            const [searchType, setSearchType] = useState('anime');
            const [results, setResults] = useState([]);
            const [searching, setSearching] = useState(false);
            const [players, setPlayers] = useState({});
            const [owner, setOwner] = useState(null);
            const [customEntry, setCustomEntry] = useState('');
            const [dismissWin, setDismissWin] = useState(false);

            useEffect(() => {
                const roomRef = fb.doc(fb.db, 'artifacts', appId, 'public', 'data', 'rooms', roomId);
                return fb.onSnapshot(roomRef, (snap) => {
                    if (snap.exists()) {
                        const d = snap.data();
                        setGridSize(d.gridSize || 3);
                        setGrid(d.grid || Array((d.gridSize || 3)**2).fill(null));
                        setTopCats(d.topCats || []);
                        setLeftCats(d.leftCats || []);
                        setTurnUid(d.turnUid);
                        setWinnerUid(d.winnerUid);
                        setPlayers(d.players || {});
                        setOwner(d.owner || null);
                    }
                });
            }, []);

            useEffect(() => {
                if (winnerUid) setDismissWin(false);
            }, [winnerUid]);

            useEffect(() => {
                if (searchType !== 'custom' && search.trim().length > 0) {
                    const timer = setTimeout(async () => {
                        setSearching(true);
                        try {
                            const url = searchType === 'anime' ? `https://api.jikan.moe/v4/anime?q=${encodeURIComponent(search)}&limit=12` : `https://api.jikan.moe/v4/characters?q=${encodeURIComponent(search)}&limit=12`;
                            const r = await fetch(url);
                            const d = await r.json();
                            setResults(d.data?.map(m => ({ id: m.mal_id, title: m.title_english || m.title || m.name, image: m.images.webp.large_image_url || m.images.webp.image_url })) || []);
                        } catch(e) {} finally { setSearching(false); }
                    }, 500);
                    return () => clearTimeout(timer);
                } else setResults([]);
            }, [search, searchType]);

            const changeGridSize = async (newSize) => {
                if (user.uid !== owner) return;
                const roomRef = fb.doc(fb.db, 'artifacts', appId, 'public', 'data', 'rooms', roomId);
                await fb.updateDoc(roomRef, {
                    gridSize: newSize,
                    grid: Array(newSize * newSize).fill(null),
                    topCats: shuffleAndPick(CAT_PHYSICAL, newSize),
                    leftCats: shuffleAndPick(CAT_TRAITS, newSize),
                    winnerUid: null,
                    turnUid: user.uid
                });
            };

            const checkWin = (g, s) => {
                const target = 3; // ปรับให้ชนะที่ 3 ช่องเรียงกัน
                
                const hasLine = (indices) => {
                    let count = 0;
                    for(let idx of indices) {
                        if(g[idx] && g[idx].uid === user.uid) {
                            count++;
                            if(count >= target) return true;
                        } else {
                            count = 0;
                        }
                    }
                    return false;
                };

                // แนวนอน
                for (let r = 0; r < s; r++) {
                    const indices = []; for (let c = 0; c < s; c++) indices.push(r * s + c);
                    if (hasLine(indices)) return true;
                }
                // แนวตั้ง
                for (let c = 0; c < s; c++) {
                    const indices = []; for (let r = 0; r < s; r++) indices.push(r * s + c);
                    if (hasLine(indices)) return true;
                }
                // ทแยงลง
                const diag1 = []; for (let i = 0; i < s; i++) diag1.push(i * s + i);
                if (hasLine(diag1)) return true;
                
                // ทแยงขึ้น
                const diag2 = []; for (let i = 0; i < s; i++) diag2.push(i * s + (s - 1 - i));
                if (hasLine(diag2)) return true;

                return false;
            };

            const selectItem = async (item) => {
                if (activeCell === null) return;
                const roomRef = fb.doc(fb.db, 'artifacts', appId, 'public', 'data', 'rooms', roomId);
                const snap = await fb.getDoc(roomRef);
                if (!snap.exists()) return;
                const d = snap.data();
                const latestGrid = [...(d.grid || Array(gridSize * gridSize).fill(null))];
                const order = d.playerOrder || [];
                latestGrid[activeCell] = { title: item.title, image: item.image || null, uid: user.uid, by: playerName || 'ไม่ระบุชื่อ' };
                const won = checkWin(latestGrid, gridSize);
                const nextTurn = order[(order.indexOf(user.uid) + 1) % order.length];
                await fb.updateDoc(roomRef, { grid: latestGrid, turnUid: won ? user.uid : nextTurn, winnerUid: won ? user.uid : null });
                setActiveCell(null); setSearch(''); setCustomEntry('');
            };

            const isTurn = user.uid === turnUid;

            return (
                <div className="flex-1 p-6 flex flex-col items-center animate-slide-up">
                    <div className="w-full max-w-6xl flex flex-col items-center gap-4 mb-6">
                        <div className="w-full flex justify-between items-center px-2">
                            <button onClick={onBack} className="text-neutral-500 font-bold flex items-center hover:text-white transition-colors thai-header"><Icon name="back" className="mr-2" /> ออก</button>
                            <div className="flex gap-4 items-center">
                                {user.uid === owner && (
                                    <div className="bg-[#262626] p-1.5 rounded-2xl border border-white/5 flex gap-1">
                                        {[3, 4, 5].map(s => (
                                            <button key={s} onClick={() => changeGridSize(s)} className={`px-4 py-1.5 rounded-xl text-xs font-black transition-all ${gridSize === s ? 'bg-indigo-600 text-white' : 'text-neutral-500 hover:text-white'}`}>{s}x{s}</button>
                                        ))}
                                    </div>
                                )}
                                <div className={`px-8 py-2.5 rounded-2xl border font-bold transition-all text-xl thai-header shadow-lg ${isTurn && !winnerUid ? 'bg-indigo-600 text-white ring-2 ring-indigo-500/30' : 'bg-[#262626] text-neutral-500 border-white/5'}`}>
                                    {isTurn ? 'ตาของคุณแล้ว' : players[turnUid] ? `ตาของ ${players[turnUid].toUpperCase()}` : 'กำลังรอ...'}
                                </div>
                                <div className="bg-indigo-600/10 px-6 py-2.5 rounded-2xl font-mono text-indigo-400 font-bold border border-indigo-500/20 shadow-inner">ห้อง: {roomId}</div>
                            </div>
                        </div>

                        {/* Players Bar at TOP */}
                        <div className="flex flex-wrap justify-center gap-2 w-full py-2">
                            {Object.entries(players).map(([uid, name]) => (
                                <div key={uid} className={`flex items-center gap-2 px-4 py-1.5 rounded-full border shadow-sm transition-all ${uid === turnUid ? 'bg-indigo-600 border-indigo-400 text-white' : 'bg-[#262626] border-white/5 text-neutral-500'}`}>
                                    <div className={`w-2 h-2 rounded-full ${uid === turnUid ? 'bg-white animate-pulse' : 'bg-neutral-600'}`}></div>
                                    <span className="font-bold text-xs thai-header truncate max-w-[120px] uppercase">{name}</span>
                                </div>
                            ))}
                        </div>
                    </div>

                    <div className="bg-[#262626] p-4 md:p-8 rounded-[3rem] border border-white/5 w-full max-w-5xl overflow-x-auto shadow-2xl custom-scrollbar">
                        <div 
                            className="grid gap-2 md:gap-4 min-w-[500px]" 
                            style={{ gridTemplateColumns: `repeat(${gridSize + 1}, minmax(0, 1fr))` }}
                        >
                            <div className="aspect-square"></div>
                            {topCats.slice(0, gridSize).map((c, i) => (
                                <div key={i} className="aspect-square bg-indigo-900/30 rounded-2xl flex items-center justify-center p-3 text-center font-black text-indigo-300 text-sm md:text-2xl leading-tight border border-indigo-500/10 shadow-inner uppercase thai-header">
                                    {c}
                                </div>
                            ))}
                            {leftCats.slice(0, gridSize).map((lc, r) => (
                                <Fragment key={r}>
                                    <div className="aspect-square bg-pink-900/30 rounded-2xl flex items-center justify-center p-3 text-center font-black text-pink-300 text-sm md:text-2xl leading-tight border border-pink-500/10 shadow-inner uppercase thai-header">
                                        {lc}
                                    </div>
                                    {Array.from({length: gridSize}).map((_, c) => {
                                        const idx = r * gridSize + c;
                                        const cell = grid[idx];
                                        const isMine = cell && cell.uid === user.uid;
                                        return (
                                            <button 
                                                key={c} 
                                                disabled={!isTurn || !!cell || winnerUid} 
                                                onClick={() => setActiveCell(idx)} 
                                                className={`aspect-square rounded-[1.5rem] overflow-hidden relative flex items-center justify-center transition-all ${cell ? (isMine ? 'border-4 border-green-500 shadow-[0_0_15px_rgba(34,197,94,0.3)]' : 'border-4 border-pink-500 scale-95 opacity-80') : 'bg-[#1a1a1a] hover:bg-indigo-500/10 shadow-inner border border-white/5 active:scale-95'}`}
                                            >
                                                {cell ? (
                                                    cell.image ? <img src={cell.image} className="w-full h-full object-cover" /> : <div className="p-2 text-center text-sm md:text-xl font-black text-white leading-tight thai-header uppercase">{cell.title}</div>
                                                ) : (isTurn && !winnerUid && <div className="text-indigo-500/20 text-4xl font-black">+</div>)}
                                                {cell && <div className="absolute top-1 right-1 bg-black/60 text-[8px] px-1 rounded text-white font-bold">{cell.by}</div>}
                                            </button>
                                        );
                                    })}
                                </Fragment>
                            ))}
                        </div>
                    </div>

                    {winnerUid && !dismissWin && (
                        <div className="fixed inset-0 z-50 bg-black/80 backdrop-blur-xl flex flex-col items-center justify-center p-6 text-center animate-slide-up">
                            <Icon name="trophy" size={120} className="text-yellow-400 mb-8 animate-victory mx-auto" />
                            <h2 className="text-8xl font-black text-white mb-4 uppercase tracking-tighter thai-header">BINGO!</h2>
                            <p className="text-3xl text-indigo-400 font-bold mb-12 thai-header">{players[winnerUid]} ชนะการแข่งขัน!</p>
                            <div className="flex gap-4">
                                <button onClick={() => setDismissWin(true)} className="bg-white/10 px-10 py-5 rounded-3xl font-black text-xl thai-header border border-white/5">ดูตาราง</button>
                                {user.uid === owner && <button onClick={() => changeGridSize(gridSize)} className="btn-primary px-10 py-5 rounded-3xl font-black text-xl thai-header shadow-lg">เริ่มเกมใหม่</button>}
                            </div>
                        </div>
                    )}

                    {activeCell !== null && (
                        <div className="fixed inset-0 z-[100] flex items-center justify-center p-4 bg-black/95 backdrop-blur-md">
                            <div className="w-full max-w-xl bg-[#262626] rounded-[3rem] h-[80vh] flex flex-col animate-slide-up shadow-2xl overflow-hidden border border-white/5">
                                <div className="p-8 border-b border-white/5 flex justify-between items-center bg-[#2a2a2a]">
                                    <h3 className="text-2xl font-bold thai-header">เลือกรายการ</h3>
                                    <button onClick={() => setActiveCell(null)} className="text-neutral-500 hover:text-white transition-colors"><Icon name="close" /></button>
                                </div>
                                <div className="flex border-b border-white/5 font-black bg-[#1a1a1a]">
                                    <button onClick={() => setSearchType('anime')} className={`flex-1 py-5 text-lg thai-header transition-all ${searchType === 'anime' ? 'text-indigo-400 border-b-2 border-indigo-400 bg-indigo-400/5' : 'text-neutral-500'}`}>อนิเมะ</button>
                                    <button onClick={() => setSearchType('character')} className={`flex-1 py-5 text-lg thai-header transition-all ${searchType === 'character' ? 'text-pink-400 border-b-2 border-pink-400 bg-pink-500/5' : 'text-neutral-500'}`}>ตัวละคร</button>
                                    <button onClick={() => setSearchType('custom')} className={`flex-1 py-5 text-lg thai-header transition-all ${searchType === 'custom' ? 'text-orange-400 border-b-2 border-orange-400 bg-orange-400/5' : 'text-neutral-500'}`}>พิมพ์เอง</button>
                                </div>
                                <div className="flex-1 overflow-y-auto p-8 custom-scrollbar">
                                    {searchType !== 'custom' ? (
                                        <Fragment>
                                            <input autoFocus value={search} onChange={e => setSearch(e.target.value)} className="w-full bg-[#1a1a1a] border border-white/5 rounded-2xl p-5 mb-6 text-white font-bold text-xl outline-none focus:ring-2 focus:ring-indigo-500/30 shadow-inner" placeholder="ค้นหา..." />
                                            <div className="grid grid-cols-2 gap-4">
                                                {searching && <div className="col-span-2 text-center text-indigo-400 animate-pulse font-black py-10 uppercase tracking-widest thai-header">กำลังค้นหา...</div>}
                                                {results.map(item => (
                                                    <button key={item.id} onClick={() => selectItem(item)} className="text-left group animate-slide-up bg-[#1a1a1a] p-3 rounded-2xl border border-white/5 hover:border-indigo-500/40">
                                                        <div className="aspect-[3/4] rounded-xl overflow-hidden mb-2 bg-[#1a1a1a] border border-white/5 shadow-inner"><img src={item.image} className="w-full h-full object-cover group-hover:scale-105 transition-transform" /></div>
                                                        <p className="text-sm font-bold text-neutral-400 group-hover:text-white line-clamp-2 thai-header">{item.title}</p>
                                                    </button>
                                                ))}
                                            </div>
                                        </Fragment>
                                    ) : (
                                        <div className="h-full flex flex-col items-center justify-center space-y-8 p-4">
                                            <div className="w-full text-center">
                                                <p className="text-neutral-500 font-bold mb-4 thai-header text-lg">พิมพ์ชื่อที่ต้องการใส่ลงตาราง</p>
                                                <input autoFocus value={customEntry} onChange={e => setCustomEntry(e.target.value)} onKeyDown={(e) => e.key === 'Enter' && selectItem({title: customEntry.trim()})} className="w-full bg-[#1a1a1a] border border-white/5 rounded-3xl p-8 text-white text-3xl font-black outline-none focus:ring-2 focus:ring-orange-500/30 text-center thai-header shadow-inner" placeholder="พิมพ์ชื่อที่นี่..." />
                                            </div>
                                            <button onClick={() => selectItem({title: customEntry.trim()})} className="w-full py-6 bg-orange-600 text-white rounded-3xl font-black text-2xl shadow-lg hover:bg-orange-700 transition-all active:scale-95 thai-header">ตกลง</button>
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        // --- YES/NO GUESSING GAME ---
        function GuessingGame({ fb, appId, roomId, onBack, user, playerName }) {
            const [roomData, setRoomData] = useState(null);
            const [search, setSearch] = useState('');
            const [searchType, setSearchType] = useState('anime'); 
            const [results, setResults] = useState([]);
            const [picking, setPicking] = useState(false);
            const [searching, setSearching] = useState(false);
            const [customName, setCustomName] = useState('');

            useEffect(() => {
                const roomRef = fb.doc(fb.db, 'artifacts', appId, 'public', 'data', 'rooms', roomId);
                return fb.onSnapshot(roomRef, (snap) => { if (snap.exists()) setRoomData(snap.data()); });
            }, []);

            useEffect(() => {
                if (searchType !== 'custom' && search.trim()) {
                    const t = setTimeout(async () => {
                        setSearching(true);
                        try {
                            const url = searchType === 'anime' ? `https://api.jikan.moe/v4/anime?q=${encodeURIComponent(search)}&limit=10` : `https://api.jikan.moe/v4/characters?q=${encodeURIComponent(search)}&limit=10`;
                            const r = await fetch(url);
                            const d = await r.json();
                            setResults(d.data?.map(m => ({ title: m.title_english || m.title || m.name, image: m.images.webp.large_image_url || m.images.webp.image_url })) || []);
                        } catch(e) {} finally { setSearching(false); }
                    }, 500);
                    return () => clearTimeout(t);
                } else setResults([]);
            }, [search, searchType]);

            const setSecret = async (item) => {
                const roomRef = fb.doc(fb.db, 'artifacts', appId, 'public', 'data', 'rooms', roomId);
                await fb.updateDoc(roomRef, { [`secrets.${user.uid}`]: { title: item.title, image: item.image || null }, [`reveals.${user.uid}`]: false });
                setPicking(false); setSearch(''); setCustomName('');
            };

            const setManualSecret = async () => { if (!customName.trim()) return; await setSecret({ title: customName.trim(), image: null }); };
            const revealMyAnswer = async () => { const roomRef = fb.doc(fb.db, 'artifacts', appId, 'public', 'data', 'rooms', roomId); await fb.updateDoc(roomRef, { [`reveals.${user.uid}`]: true }); };

            if (!roomData) return null;

            return (
                <div className="flex-1 p-6 flex flex-col items-center animate-slide-up">
                    <div className="w-full max-w-4xl flex justify-between items-center mb-6">
                        <button onClick={onBack} className="text-neutral-500 font-bold flex items-center hover:text-white transition-colors thai-header"><Icon name="back" className="mr-2" /> ออก</button>
                        <div className="bg-indigo-600/10 px-8 py-2.5 rounded-2xl font-mono text-indigo-400 font-bold border border-indigo-500/20 shadow-inner">ห้อง: {roomId}</div>
                    </div>
                    
                    <div className="w-full max-w-5xl flex flex-wrap justify-center gap-2 mb-8">
                        {Object.entries(roomData.players).map(([uid, name]) => (
                            <div key={uid} className={`flex items-center gap-3 px-6 py-2 rounded-full border bg-[#262626] border-white/5 transition-all shadow-md`}>
                                <div className={`w-2 h-2 rounded-full ${roomData.secrets?.[uid] ? 'bg-green-500 shadow-[0_0_5px_rgba(34,197,94,0.5)]' : 'bg-neutral-600'}`}></div>
                                <span className="font-bold text-xs thai-header truncate max-w-[150px] uppercase text-neutral-400">{name}</span>
                            </div>
                        ))}
                    </div>

                    <div className="w-full max-w-5xl grid grid-cols-1 md:grid-cols-2 gap-10">
                        <div className="bg-[#262626] p-10 rounded-[4rem] border border-white/5 shadow-2xl flex flex-col items-center text-center">
                            <h3 className="text-2xl font-black text-neutral-500 mb-8 thai-header uppercase tracking-widest">ตัวละครลับของคุณ</h3>
                            {roomData.secrets?.[user.uid] ? (
                                <div className="w-full space-y-8">
                                    <div className="bg-indigo-500/10 border-2 border-indigo-500/30 p-10 rounded-[3rem] w-full relative">
                                        {roomData.secrets[user.uid].image ? <img src={roomData.secrets[user.uid].image} className="w-40 h-56 object-cover rounded-3xl mx-auto mb-6 shadow-2xl" /> : <div className="w-40 h-56 bg-indigo-500/20 rounded-3xl mx-auto mb-6 flex items-center justify-center"><Icon name="user" size={64} className="text-indigo-400 opacity-50" /></div>}
                                        <p className="text-4xl font-black text-indigo-400 thai-header leading-tight">{roomData.secrets[user.uid].title}</p>
                                    </div>
                                    {!roomData.reveals?.[user.uid] && <button onClick={revealMyAnswer} className="w-full py-6 bg-red-600/20 text-red-400 border border-red-500/30 rounded-3xl font-black text-2xl thai-header hover:bg-red-600 hover:text-white transition-all shadow-xl">เฉลยตัวละคร</button>}
                                </div>
                            ) : (
                                <button onClick={() => setPicking(true)} className="w-full py-20 border-4 border-dashed border-white/5 rounded-[3rem] text-indigo-400/50 font-black text-3xl hover:bg-indigo-500/5 transition-all thai-header">เลือกตัวละครลับ</button>
                            )}
                        </div>
                        <div className="bg-[#262626] p-10 rounded-[4rem] border border-white/5 shadow-2xl flex flex-col">
                            <h3 className="text-2xl font-black text-neutral-500 mb-8 thai-header text-center uppercase tracking-widest">สถานะเพื่อน</h3>
                            <div className="space-y-4 max-h-[50vh] overflow-y-auto custom-scrollbar pr-2">
                                {Object.entries(roomData.players).map(([uid, name]) => (
                                    <div key={uid} className={`p-6 rounded-[2rem] border transition-all ${roomData.secrets?.[uid] ? 'bg-indigo-500/5 border-indigo-500/20' : 'bg-[#1a1a1a] border-white/5'}`}>
                                        <div className="flex justify-between items-center">
                                            <span className="font-black text-2xl text-white thai-header">{name}</span>
                                            {roomData.reveals?.[uid] && <span className="text-xs bg-pink-500 text-white px-3 py-1 rounded-full font-black thai-header">เฉลยแล้ว</span>}
                                        </div>
                                        {roomData.reveals?.[uid] && roomData.secrets?.[uid] && (
                                            <div className="mt-6 pt-6 border-t border-white/5 text-center animate-slide-up">
                                                {roomData.secrets[uid].image && <img src={roomData.secrets[uid].image} className="w-24 h-32 object-cover rounded-2xl mx-auto mb-3 border border-white/10" />}
                                                <p className="text-2xl font-black text-white thai-header">{roomData.secrets[uid].title}</p>
                                            </div>
                                        )}
                                    </div>
                                ))}
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        // --- TIER LIST GAME ---
        function TierListGame({ fb, appId, roomId, onBack, user, playerName }) {
            const [roomData, setRoomData] = useState(null);
            const [search, setSearch] = useState('');
            const [searchType, setSearchType] = useState('anime_single');
            const [results, setResults] = useState([]);
            const [searching, setSearching] = useState(false);
            const [adding, setAdding] = useState(false);
            const [bulkLoadingId, setBulkLoadingId] = useState(null);
            const [dragOverTierId, setDragOverTierId] = useState(null);
            const [dragOverItemId, setDragOverItemId] = useState(null);

            useEffect(() => {
                const roomRef = fb.doc(fb.db, 'artifacts', appId, 'public', 'data', 'rooms', roomId);
                return fb.onSnapshot(roomRef, (snap) => { if (snap.exists()) setRoomData(snap.data()); });
            }, []);

            useEffect(() => {
                if (search.trim()) {
                    const t = setTimeout(async () => {
                        setSearching(true);
                        try {
                            const isAnimeSearch = searchType === 'anime_single' || searchType === 'anime_chars';
                            const url = isAnimeSearch ? `https://api.jikan.moe/v4/anime?q=${encodeURIComponent(search)}&limit=10` : `https://api.jikan.moe/v4/characters?q=${encodeURIComponent(search)}&limit=10`;
                            const r = await fetch(url);
                            const d = await r.json();
                            setResults(d.data?.map(m => ({ id: m.mal_id, title: m.title_english || m.title || m.name, image: m.images?.webp?.large_image_url || m.images?.webp?.image_url })) || []);
                        } catch(e) {} finally { setSearching(false); }
                    }, 500);
                    return () => clearTimeout(t);
                } else setResults([]);
            }, [search, searchType]);

            const updateItemTier = async (instanceId, newTier) => {
                const roomRef = fb.doc(fb.db, 'artifacts', appId, 'public', 'data', 'rooms', roomId);
                const updatedItems = roomData.tierItems.map(item => item.instanceId === instanceId ? { ...item, tier: newTier } : item);
                await fb.updateDoc(roomRef, { tierItems: updatedItems });
            };

            const reorderItem = async (sourceId, targetId) => {
                if (sourceId === targetId) return;
                const roomRef = fb.doc(fb.db, 'artifacts', appId, 'public', 'data', 'rooms', roomId);
                const items = [...roomData.tierItems];
                const sIdx = items.findIndex(i => i.instanceId === sourceId);
                const tIdx = items.findIndex(i => i.instanceId === targetId);
                const targetTier = items[tIdx].tier;
                const [movedItem] = items.splice(sIdx, 1);
                movedItem.tier = targetTier;
                const newTIdx = items.findIndex(i => i.instanceId === targetId);
                items.splice(newTIdx, 0, movedItem);
                await fb.updateDoc(roomRef, { tierItems: items });
            };

            const onDragStart = (e, instanceId) => { e.dataTransfer.setData("instanceId", instanceId); };
            const onDropOnTier = async (e, tierId) => { e.preventDefault(); setDragOverTierId(null); setDragOverItemId(null); const instanceId = e.dataTransfer.getData("instanceId"); if (instanceId) await updateItemTier(instanceId, tierId); };
            const onDropOnItem = async (e, targetId) => { e.preventDefault(); e.stopPropagation(); setDragOverTierId(null); setDragOverItemId(null); const sourceId = e.dataTransfer.getData("instanceId"); if (sourceId) await reorderItem(sourceId, targetId); };

            if (!roomData) return null;

            const tiers = roomData.tiers || [];
            const tierItems = roomData.tierItems || [];

            const renderDraggableItem = (item, isLarge = false) => (
                <div key={item.instanceId} draggable onDragStart={(e) => onDragStart(e, item.instanceId)} onDragOver={(e) => { e.preventDefault(); e.stopPropagation(); setDragOverItemId(item.instanceId); }} onDragLeave={() => setDragOverItemId(null)} onDrop={(e) => onDropOnItem(e, item.instanceId)} className={`relative group/item cursor-grab active:cursor-grabbing transition-all ${dragOverItemId === item.instanceId ? 'item-drag-target' : ''}`}>
                    <img src={item.image} className={`${isLarge ? 'w-24 h-32' : 'w-20 h-28'} object-cover rounded-xl shadow-lg border border-white/5 group-hover/item:scale-105 transition-transform`} />
                    {isLarge && <p className="text-[10px] text-center mt-2 font-bold text-neutral-500 line-clamp-1 w-24 thai-header uppercase">{item.title}</p>}
                    <div className="absolute inset-0 bg-black/60 opacity-0 group-hover/item:opacity-100 transition-opacity flex flex-col items-center justify-center gap-2 rounded-xl">
                        <button onClick={(e) => { e.stopPropagation(); item.tier === 'unranked' ? fb.updateDoc(fb.doc(fb.db, 'artifacts', appId, 'public', 'data', 'rooms', roomId), { tierItems: roomData.tierItems.filter(i => i.instanceId !== item.instanceId) }) : updateItemTier(item.instanceId, 'unranked'); }} className="bg-red-500 text-white p-2 rounded-full shadow-lg hover:scale-110 transition-transform"><Icon name="close" size={isLarge ? 18 : 20} /></button>
                    </div>
                </div>
            );

            return (
                <div className="flex-1 p-6 flex flex-col items-center animate-slide-up">
                    <div className="w-full max-w-6xl flex justify-between items-center mb-8">
                        <button onClick={onBack} className="text-neutral-500 font-bold flex items-center hover:text-white transition-colors thai-header"><Icon name="back" className="mr-2" /> ออก</button>
                        <div className="flex gap-4">
                            <button onClick={() => setAdding(true)} className="bg-orange-600 text-white px-8 py-3 rounded-2xl font-bold flex items-center hover:bg-orange-700 transition-all shadow-lg thai-header"><Icon name="sparkles" size={18} className="mr-2" /> เพิ่มรายการ</button>
                            <div className="bg-orange-600/20 px-6 py-3 rounded-2xl font-mono text-orange-400 font-bold border border-orange-500/20 shadow-inner uppercase">ห้อง: {roomId}</div>
                        </div>
                    </div>

                    <div className="w-full max-w-6xl space-y-10">
                        {/* Players Bar at TOP */}
                        <div className="flex flex-wrap justify-center gap-2 py-4 border-b border-white/5">
                            {Object.entries(roomData.players || {}).map(([uid, name]) => (
                                <div key={uid} className={`flex items-center gap-3 px-5 py-1.5 rounded-full border bg-[#262626] border-white/5 shadow-md`}>
                                    <div className="w-2 h-2 rounded-full bg-orange-500 shadow-[0_0_5px_rgba(249,115,22,0.5)]"></div>
                                    <span className={`font-bold text-xs thai-header truncate max-w-[120px] uppercase ${uid === user.uid ? 'text-orange-400' : 'text-neutral-400'}`}>{name}</span>
                                </div>
                            ))}
                        </div>

                        {/* Tier Rows */}
                        <div className="space-y-4">
                            {tiers.map(tier => (
                                <div key={tier.id} onDragOver={(e) => { e.preventDefault(); setDragOverTierId(tier.id); }} onDragLeave={() => setDragOverTierId(null)} onDrop={(e) => onDropOnTier(e, tier.id)} className={`flex bg-[#262626] rounded-3xl overflow-hidden border border-white/5 shadow-xl transition-all ${dragOverTierId === tier.id ? 'drag-over' : ''}`}>
                                    <div className={`${tier.color} w-32 flex flex-col items-center justify-center p-2 text-center shadow-inner relative group`}><span className="text-3xl font-black text-black/70 thai-header">{tier.label}</span></div>
                                    <div className="flex-1 p-4 flex flex-wrap gap-4 tier-row">{tierItems.filter(i => i.tier === tier.id).map(item => renderDraggableItem(item))}</div>
                                </div>
                            ))}
                            <div className="mt-12">
                                <div className="flex justify-between items-center mb-6 border-b border-white/5 pb-4">
                                    <h3 className="text-xl font-bold text-neutral-500 uppercase tracking-widest thai-header">คลังตัวละคร</h3>
                                    <button onClick={async () => { await fb.updateDoc(fb.doc(fb.db, 'artifacts', appId, 'public', 'data', 'rooms', roomId), { tierItems: roomData.tierItems.filter(item => item.tier !== 'unranked') }); }} className="flex items-center gap-2 text-xs font-bold text-red-500 hover:text-red-400 transition-colors bg-red-500/10 px-5 py-2 rounded-2xl border border-red-500/20 thai-header"><Icon name="trash" size={14} /> ล้างคลัง</button>
                                </div>
                                <div onDragOver={(e) => { e.preventDefault(); setDragOverTierId('unranked'); }} onDragLeave={() => setDragOverTierId(null)} onDrop={(e) => onDropOnTier(e, 'unranked')} className={`flex flex-wrap gap-6 min-h-[200px] p-8 bg-[#1a1a1a] rounded-[3rem] border border-white/5 shadow-inner transition-all ${dragOverTierId === 'unranked' ? 'drag-over' : ''}`}>{tierItems.filter(i => i.tier === 'unranked').map(item => renderDraggableItem(item, true))}</div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        const root = document.getElementById('root');
        ReactDOM.createRoot(root).render(<App />);
    </script>
</body>
</html>
