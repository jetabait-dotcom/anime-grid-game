<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Anime Game Hub - ศูนย์รวมเกมอนิเมะ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Anuphan:wght@300;400;500;600;700;800&display=swap');
        body { 
            background-color: #171717; 
            color: #f5f5f5; 
            font-family: 'Anuphan', sans-serif; 
            margin: 0; 
            overflow-x: hidden; 
            line-height: 1.6;
        }
        .text-gradient { background: linear-gradient(to right, #a78bfa, #f472b6); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .btn-primary { background-color: #4f46e5; transition: all 0.2s; }
        .thai-header { letter-spacing: 0.02em; line-height: 1.3; font-weight: 800; }
        .btn-primary:hover { background-color: #4338ca; transform: translateY(-1px); }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .animate-slide-up { animation: slideUp 0.4s ease-out forwards; }
        @keyframes crownBounce { 0%, 100% { transform: translateY(0) rotate(0); } 50% { transform: translateY(-10px) rotate(5deg); } }
        .animate-victory { animation: crownBounce 2s infinite ease-in-out; }
        .tier-row { min-height: 120px; transition: all 0.2s; position: relative; }
        .drag-over { background-color: rgba(79, 70, 229, 0.1) !important; border: 2px dashed #4f46e5 !important; }
        .item-drag-target { border-left: 4px solid #4f46e5 !important; margin-left: -2px; }
        .hint-pulse { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: .5; } }
    </style>
</head>
<body class="bg-[#171717]">
    <div id="root"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, updateDoc, onSnapshot, collection, arrayUnion } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDy3A8XwrKA-BXjlueZzzTa5BQ1R1SFVzk",
            authDomain: "game-hub-jetabait.firebaseapp.com",
            projectId: "game-hub-jetabait",
            storageBucket: "game-hub-jetabait.firebasestorage.app",
            messagingSenderId: "788930921640",
            appId: "1:788930921640:web:f54c7d47012b4f50a0ee9d",
            measurementId: "G-TL5GQ6BX61"
        };

        try {
            const app = initializeApp(firebaseConfig);
            const auth = getAuth(app);
            const db = getFirestore(app);
            window.FirebaseSDK = { auth, db, doc, setDoc, getDoc, updateDoc, onSnapshot, collection, signInAnonymously, signInWithCustomToken, onAuthStateChanged, arrayUnion };
        } catch (e) { console.error("Firebase Error", e); }
    </script>

    <script type="text/babel">
        const { useState, useEffect, useRef, Fragment, useCallback } = React;

        const Icon = ({ name, size = 24, className = "" }) => {
            const icons = {
                gamepad: <path d="M6 12h4m-2-2v4m7-1h.01m2.99-2h.01M2 6a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V6Z"/>,
                grid: <path d="M3 3h7v7H3V3Zm11 0h7v7h-7V3ZM3 14h7v7H3v-7Zm11 0h7v7h-7v-7Z"/>,
                back: <path d="m15 18-6-6 6-6"/>,
                users: <Fragment><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></Fragment>,
                user: <Fragment><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></Fragment>,
                search: <Fragment><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></Fragment>,
                close: <path d="M18 6 6 18M6 6l12 12"/>,
                check: <path d="M20 6 9 17l-5-5"/>,
                playCircle: <Fragment><circle cx="12" cy="12" r="10"/><polygon points="10 8 16 12 10 16 10 8"/></Fragment>,
                help: <Fragment><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><line x1="12" y1="17" x2="12.01" y2="17"/></Fragment>,
                sparkles: <path d="m12 3 1.912 5.885L20 10.8l-5.088 1.915L12 18.6l-1.912-5.885L5 10.8l5.088-1.915L12 3Z"/>,
                trophy: <path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6M18 9h1.5a2.5 2.5 0 0 0 0-5H18M4 22h16M10 14.66V17c0 .55.45 1 1 1h2c.55 0 1-.45 1-1v-2.34c3.12-.5 5-2.66 5-5.66V2H6v7c0 3 1.88 5.16 5 5.66z"/>,
                layers: <path d="m12.89 1.45 8 4.61a2 2 0 0 1 0 3.47l-8 4.61a2 2 0 0 1-2 0l-8-4.61a2 2 0 0 1 0-3.47l8-4.61a2 2 0 0 1 2 0z M2.11 12.57l8 4.61a2 2 0 0 0 2 0l8-4.61 M2.11 16.57l8 4.61a2 2 0 0 0 2 0l8-4.61" />,
                download: <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M7 10l5 5 5-5M12 15V3"/>,
                trash: <path d="M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2M10 11v6M14 11v6" />,
                book: <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20M4 19.5A2.5 2.5 0 0 0 6.5 22H20V5H6.5A2.5 2.5 0 0 0 4 7.5v12z" />,
                settings: <Fragment><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></Fragment>,
                filter: <path d="M22 3H2l8 9.46V19l4 2v-8.54L22 3z" />,
                message: <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z" />
            };
            return (
                <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                    {icons[name]}
                </svg>
            );
        };

        const CAT_PHYSICAL = ["ผู้หญิง", "ผู้ชาย", "ผมชมพู", "ผมสองสี", "ผมส้ม", "ผมน้ำตาล", "ผมเทา", "ผมขาว", "ผมฟ้า", "ผมบลอนด์", "ผมเขียว", "ผมแดง", "ผมม่วง", "ผมสั้น", "ผมยาว", "หัวโล้น", "ผ้าปิดตา", "รอยสัก", "แผลเป็น", "แว่นตา", "หมวก", "หน้ากาก", "ผ้าคลุม", "ผ้าพันคอ", "ชุดสูท", "ปีก", "หาง", "เขี้ยว", "เขา", "กล้ามเนื้อ", "หุ่นยนต์", "ไซบอร์ก", "ผิวแทน", "ผู้สูงอายุ", "เด็ก", "อมนุษย์", "นักเรียน"];
        const CAT_TRAITS = ["พลังไฟ", "พลังน้ำ", "พลังสายฟ้า", "พลังน้ำแข็ง", "พลังจิต", "แปลงร่าง", "พระเอก/นางเอก", "ตัวร้าย", "นางเอก (Heroine)", "ตัวตลก", "คล้ายสัตว์", "พระเจ้า", "ปีศาจ", "แวมไพร์", "เอลฟ์", "เอเลี่ยน", "อาจารย์", "ผู้ใช้ดาบ", "ผู้ใช้ปืน", "นักเวทย์", "อัศวิน", "ไอดอล", "นักดนตรี", "ราชวงศ์", "เมด/พ่อบ้าน", "ยากูซ่า", "โจรสลัด", "นินจา", "เชฟ", "คุณหมอ", "นักสืบ", "สายลับ", "พี่น้อง", "เจ้าของสัตว์เลี้ยง", "ต่างโลก (Isekai)", "ระทึกขวัญ", "ชีวิตประจำวัน", "โรงเรียน", "ตลก", "โรแมนติก", "ไซไฟ", "ปริศนา", "สยองขวัญ", "กีฬา", "โลกอนาคต", "ฮาเร็ม", "ดราม่า"];

        const shuffleAndPick = (arr, count) => [...arr].sort(() => Math.random() - 0.5).slice(0, count);

        // --- Common Search UI Component with Filters ---
        function SearchInterface({ search, setSearch, searchType, setSearchType, results, searching, filters, setFilters, onSelect, onCancel }) {
            const animeTypes = ["tv", "movie", "ova", "special", "ona"];

            return (
                <div className="fixed inset-0 z-[500] flex items-center justify-center p-4 bg-black/90 backdrop-blur-md">
                    <div className="w-full max-w-xl bg-[#262626] rounded-[3rem] h-[85vh] flex flex-col animate-slide-up shadow-2xl overflow-hidden border border-white/5">
                        <div className="p-8 border-b border-white/5 flex justify-between items-center bg-[#2a2a2a]">
                            <h3 className="text-2xl font-bold thai-header">ค้นหารายการ</h3>
                            <button onClick={onCancel} className="text-neutral-500 hover:text-white transition-colors"><Icon name="close" /></button>
                        </div>
                        
                        <div className="flex border-b border-white/5 font-black bg-[#1a1a1a]">
                            <button onClick={() => setSearchType('anime')} className={`flex-1 py-5 text-lg thai-header transition-all ${searchType.includes('anime') ? 'text-indigo-400 border-b-2 border-indigo-400 bg-indigo-400/5' : 'text-neutral-500'}`}>อนิเมะ</button>
                            <button onClick={() => setSearchType('character')} className={`flex-1 py-5 text-lg thai-header transition-all ${searchType === 'character' ? 'text-pink-400 border-b-2 border-pink-400 bg-pink-500/5' : 'text-neutral-500'}`}>ตัวละคร</button>
                            <button onClick={() => setSearchType('custom')} className={`flex-1 py-5 text-lg thai-header transition-all ${searchType === 'custom' ? 'text-orange-400 border-b-2 border-orange-400 bg-orange-400/5' : 'text-neutral-500'}`}>พิมพ์เอง</button>
                        </div>

                        <div className="flex-1 overflow-y-auto p-4 custom-scrollbar">
                            {searchType !== 'custom' ? (
                                <Fragment>
                                    <div className="space-y-4 mb-6">
                                        <input autoFocus value={search} onChange={e => setSearch(e.target.value)} className="w-full bg-[#1a1a1a] border border-white/5 rounded-2xl p-4 text-white font-bold text-lg outline-none shadow-inner focus:ring-2 focus:ring-indigo-500/30" placeholder={searchType === 'character' ? "ค้นหาตัวละคร หรือชื่อเรื่องอนิเมะ..." : "พิมพ์ชื่ออนิเมะ..."} />
                                        
                                        {searchType.includes('anime') && (
                                            <div className="bg-[#1f1f1f] p-3 rounded-2xl border border-white/5 space-y-2">
                                                <div className="flex items-center gap-2 text-[10px] font-bold text-neutral-500 uppercase tracking-widest mb-1">
                                                    <Icon name="filter" size={12} /> ประเภท
                                                </div>
                                                <div className="flex flex-wrap gap-1.5">
                                                    <button 
                                                        onClick={() => setFilters(prev => ({...prev, type: ""}))}
                                                        className={`px-3 py-1.5 rounded-lg text-[10px] font-bold transition-all ${!filters.type ? 'bg-indigo-600 text-white' : 'bg-[#171717] text-neutral-500 hover:text-white'}`}
                                                    >
                                                        ทั้งหมด
                                                    </button>
                                                    {animeTypes.map(t => (
                                                        <button 
                                                            key={t}
                                                            onClick={() => setFilters(prev => ({...prev, type: t}))}
                                                            className={`px-3 py-1.5 rounded-lg text-[10px] font-bold transition-all ${filters.type === t ? 'bg-indigo-600 text-white' : 'bg-[#171717] text-neutral-500 hover:text-white'}`}
                                                        >
                                                            {t.toUpperCase()}
                                                        </button>
                                                    ))}
                                                </div>
                                            </div>
                                        )}
                                    </div>

                                    {/* ปรับเป็น 5 คอลัมน์เพื่อให้ภาพเล็กลงและกระชับ */}
                                    <div className="grid grid-cols-3 sm:grid-cols-5 gap-2 px-2">
                                        {searching && <div className="col-span-full text-center text-indigo-400 animate-pulse font-black py-10 uppercase tracking-widest text-xs thai-header">กำลังค้นหา...</div>}
                                        {!searching && results.length === 0 && search.trim().length >= 2 && <div className="col-span-full text-center text-neutral-600 font-bold py-10 text-xs thai-header">ไม่พบผลลัพธ์</div>}
                                        {results.map((item, idx) => (
                                            <button key={idx} onClick={() => onSelect(item)} className="text-left group animate-slide-up flex flex-col">
                                                <div className="aspect-[3/4] rounded-lg overflow-hidden mb-1 bg-[#1a1a1a] group-hover:border-indigo-500/50 border border-white/5 shadow-sm">
                                                    <img src={item.image} className="w-full h-full object-cover group-hover:scale-110 transition-transform duration-300" />
                                                </div>
                                                <p className="text-[9px] font-bold text-neutral-400 group-hover:text-white line-clamp-1 thai-header leading-tight px-1 text-center">{item.title}</p>
                                            </button>
                                        ))}
                                    </div>
                                </Fragment>
                            ) : (
                                <div className="h-full flex flex-col items-center justify-center space-y-6">
                                    <div className="w-full text-center px-6">
                                        <p className="text-neutral-500 font-bold mb-4 thai-header">พิมพ์สิ่งที่ต้องการใส่ในระบบ</p>
                                        <input autoFocus onKeyDown={e => {if(e.key === 'Enter' && e.target.value.trim()) onSelect({title: e.target.value})}} className="w-full bg-[#1a1a1a] border border-white/5 rounded-2xl p-6 text-white text-3xl font-black outline-none focus:ring-2 focus:ring-orange-500/30 text-center thai-header" placeholder="ระบุ..." />
                                    </div>
                                    <p className="text-neutral-600 text-[10px] font-bold thai-header italic text-center px-10">* สำหรับกรณีหาในระบบไม่เจอ</p>
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        }

        function App() {
            const [screen, setScreen] = useState('hub');
            const [user, setUser] = useState(null);
            const [fb, setFb] = useState(null);
            const [roomId, setRoomId] = useState('');
            const [gameType, setGameType] = useState('bingo');
            const [playerName, setPlayerName] = useState(localStorage.getItem('anime_player_name') || '');
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'game-hub-jetabait';

            useEffect(() => {
                const check = setInterval(() => {
                    if (window.FirebaseSDK) {
                        clearInterval(check);
                        const sdk = window.FirebaseSDK;
                        setFb(sdk);
                        sdk.onAuthStateChanged(sdk.auth, (u) => { if (u) setUser(u); });
                        const initAuth = async () => {
                            try {
                                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                                    await sdk.signInWithCustomToken(sdk.auth, __initial_auth_token);
                                } else {
                                    await sdk.signInAnonymously(sdk.auth);
                                }
                            } catch(e) { await sdk.signInAnonymously(sdk.auth); }
                        };
                        initAuth();
                    }
                }, 100);
            }, []);

            if (!user) return <div className="min-h-screen flex flex-col items-center justify-center text-indigo-400 font-bold animate-pulse text-2xl tracking-tight thai-header">กำลังเชื่อมต่อ...</div>;

            return (
                <div className="min-h-screen flex flex-col bg-[#171717]">
                    {screen === 'hub' && (
                        <div className="flex-1 flex flex-col items-center justify-center p-6 animate-slide-up text-center">
                            <h1 className="text-5xl md:text-6xl font-black text-gradient mb-12 tracking-tighter thai-header">Anime Game Hub</h1>
                            <div className="grid grid-cols-1 sm:grid-cols-3 gap-6 w-full max-w-4xl px-4">
                                <button onClick={() => {setGameType('bingo'); setScreen('lobby');}} className="bg-[#262626] p-8 md:p-10 rounded-[2.5rem] border border-white/5 hover:border-indigo-500/30 transition-all text-left group shadow-xl">
                                    <Icon name="grid" size={32} className="text-indigo-400 mb-6" />
                                    <h3 className="text-xl md:text-2xl font-bold mb-2 text-white thai-header">บิงโกกกก</h3>
                                    <p className="text-neutral-500 font-medium text-xs md:text-sm">ท้าทายการสุ่มหมวดหมู่จากอนิเมะ</p>
                                </button>
                                <button onClick={() => {setGameType('yesno'); setScreen('lobby');}} className="bg-[#262626] p-8 md:p-10 rounded-[2.5rem] border border-white/5 hover:border-pink-500/30 transition-all text-left group shadow-xl">
                                    <Icon name="help" size={32} className="text-pink-400 mb-6" />
                                    <h3 className="text-xl md:text-2xl font-bold mb-2 text-white thai-header">ทายมาสิน้อง</h3>
                                    <p className="text-neutral-500 font-medium text-xs md:text-sm">ทายตัวละครลับจากคำถาม ใช่/ไม่ใช่</p>
                                </button>
                                <button onClick={() => {setGameType('tierlist'); setScreen('lobby');}} className="bg-[#262626] p-8 md:p-10 rounded-[2.5rem] border border-white/5 hover:border-orange-500/30 transition-all text-left group shadow-xl">
                                    <Icon name="layers" size={32} className="text-orange-400 mb-6" />
                                    <h3 className="text-xl md:text-2xl font-bold mb-2 text-white thai-header">จัดเทียร์</h3>
                                    <p className="text-neutral-500 font-medium text-xs md:text-sm">จัดอันดับตัวละครร่วมกับเพื่อนๆ</p>
                                </button>
                            </div>
                        </div>
                    )}
                    {screen === 'lobby' && <Lobby fb={fb} appId={appId} gameType={gameType} onBack={() => setScreen('hub')} onJoin={(id) => {setRoomId(id); setScreen('game');}} user={user} playerName={playerName} setPlayerName={setPlayerName} />}
                    {screen === 'game' && gameType === 'bingo' && <BingoGame fb={fb} appId={appId} roomId={roomId} onBack={() => setScreen('hub')} user={user} playerName={playerName} />}
                    {screen === 'game' && gameType === 'yesno' && <GuessingGame fb={fb} appId={appId} roomId={roomId} onBack={() => setScreen('hub')} user={user} playerName={playerName} />}
                    {screen === 'game' && gameType === 'tierlist' && <TierListGame fb={fb} appId={appId} roomId={roomId} onBack={() => setScreen('hub')} user={user} playerName={playerName} />}
                </div>
            );
        }

        function Lobby({ fb, appId, gameType, onBack, onJoin, user, playerName, setPlayerName }) {
            const [roomCode, setRoomCode] = useState('');
            const displayTitles = { bingo: 'บิงโกกกก', yesno: 'ทายมาสิน้อง', tierlist: 'จัดเทียร์' };

            const handleAction = async (isCreate) => {
                if (!playerName.trim()) return;
                const id = isCreate ? Math.random().toString(36).substring(2, 5).toUpperCase() : roomCode.toUpperCase();
                const roomRef = fb.doc(fb.db, 'artifacts', appId, 'public', 'data', 'rooms', id);
                if (isCreate) {
                    const baseData = {
                        gameType, owner: user.uid, players: { [user.uid]: playerName }, playerOrder: [user.uid],
                        createdAt: new Date().toISOString(),
                        hints: {}
                    };
                    if (gameType === 'bingo') {
                        Object.assign(baseData, { 
                            grid: Array(9).fill(null), 
                            gridSize: 3, 
                            topCats: shuffleAndPick(CAT_PHYSICAL, 3), 
                            leftCats: shuffleAndPick(CAT_TRAITS, 3), 
                            turnUid: user.uid 
                        });
                    } else if (gameType === 'tierlist') {
                        Object.assign(baseData, { tierItems: [], tiers: [
                            {id: 'S', label: 'S', color: 'bg-red-500'}, {id: 'A', label: 'A', color: 'bg-orange-500'}, 
                            {id: 'B', label: 'B', color: 'bg-yellow-500'}, {id: 'C', label: 'C', color: 'bg-green-500'},
                            {id: 'D', label: 'D', color: 'bg-blue-500'}
                        ] });
                    }
                    await fb.setDoc(roomRef, baseData);
                    onJoin(id);
                } else {
                    const snap = await fb.getDoc(roomRef);
                    if (snap.exists()) {
                        const data = snap.data();
                        const newOrder = data.playerOrder || [];
                        if (!newOrder.includes(user.uid)) newOrder.push(user.uid);
                        await fb.updateDoc(roomRef, { [`players.${user.uid}`]: playerName, playerOrder: newOrder });
                        onJoin(id);
                    } else { alert("ไม่พบห้องที่ระบุ"); }
                }
            };
            return (
                <div className="flex-1 flex flex-col items-center justify-center p-6 animate-slide-up">
                    <div className="w-full max-w-sm bg-[#262626] p-8 rounded-[2.5rem] border border-white/5 shadow-2xl">
                        <button onClick={onBack} className="text-neutral-500 mb-6 flex items-center font-bold text-[10px] hover:text-white transition-colors thai-header"><Icon name="back" size={12} className="mr-1" /> กลับหน้าหลัก</button>
                        <h2 className="text-xl font-black mb-6 text-center text-gradient uppercase thai-header">โหมด {displayTitles[gameType]}</h2>
                        <div className="space-y-4">
                            <input value={playerName} onChange={e => {setPlayerName(e.target.value); localStorage.setItem('anime_player_name', e.target.value);}} className="w-full bg-[#1a1a1a] border border-white/5 rounded-xl px-5 py-3 text-white font-bold focus:outline-none focus:ring-1 focus:ring-indigo-500/50" placeholder="ใส่ชื่อเล่นของคุณ" />
                            <button onClick={() => handleAction(true)} className="w-full btn-primary py-3 rounded-xl font-black shadow-lg thai-header text-sm">สร้างห้องใหม่</button>
                            <div className="relative flex items-center py-1">
                                <div className="flex-grow border-t border-white/5"></div>
                                <span className="flex-shrink mx-3 text-neutral-600 text-[9px] font-bold uppercase thai-header">หรือเข้าร่วม</span>
                                <div className="flex-grow border-t border-white/5"></div>
                            </div>
                            <div className="flex gap-2">
                                <input value={roomCode} onChange={e => setRoomCode(e.target.value)} className="flex-1 bg-[#1a1a1a] border border-white/5 rounded-xl px-5 py-3 text-white font-mono uppercase focus:outline-none" placeholder="รหัสห้อง" />
                                <button onClick={() => handleAction(false)} className="bg-[#333] px-4 rounded-xl font-black text-xs transition-all hover:bg-[#444] thai-header">ตกลง</button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        // --- BINGO GAME ---
        function BingoGame({ fb, appId, roomId, onBack, user, playerName }) {
            const [grid, setGrid] = useState([]);
            const [gridSize, setGridSize] = useState(3);
            const [topCats, setTopCats] = useState([]);
            const [leftCats, setLeftCats] = useState([]);
            const [turnUid, setTurnUid] = useState(null);
            const [winnerUid, setWinnerUid] = useState(null);
            const [activeCell, setActiveCell] = useState(null);
            const [search, setSearch] = useState('');
            const [searchType, setSearchType] = useState('anime');
            const [filters, setFilters] = useState({ type: '' });
            const [results, setResults] = useState([]);
            const [searching, setSearching] = useState(false);
            const [players, setPlayers] = useState({});
            const [owner, setOwner] = useState(null);
            const [dismissWin, setDismissWin] = useState(false);

            useEffect(() => {
                const roomRef = fb.doc(fb.db, 'artifacts', appId, 'public', 'data', 'rooms', roomId);
                return fb.onSnapshot(roomRef, (snap) => {
                    if (snap.exists()) {
                        const d = snap.data();
                        setGridSize(d.gridSize || 3);
                        setGrid(d.grid || Array((d.gridSize || 3)**2).fill(null));
                        setTopCats(d.topCats || []);
                        setLeftCats(d.leftCats || []);
                        setTurnUid(d.turnUid);
                        setWinnerUid(d.winnerUid);
                        setPlayers(d.players || {});
                        setOwner(d.owner || null);
                    }
                });
            }, []);

            useEffect(() => {
                if (searchType !== 'custom' && search.trim().length >= 2) {
                    const timer = setTimeout(async () => {
                        setSearching(true);
                        try {
                            if (searchType === 'character') {
                                const animeRes = await fetch(`https://api.jikan.moe/v4/anime?q=${encodeURIComponent(search)}&limit=1`);
                                const animeData = await animeRes.json();
                                if (animeData.data && animeData.data.length > 0) {
                                    const mal_id = animeData.data[0].mal_id;
                                    const charRes = await fetch(`https://api.jikan.moe/v4/anime/${mal_id}/characters`);
                                    const charData = await charRes.json();
                                    if (charData.data) {
                                        setResults(charData.data.map(c => ({
                                            id: c.character.mal_id,
                                            title: c.character.name,
                                            image: c.character.images.webp.image_url
                                        })));
                                        setSearching(false);
                                        return;
                                    }
                                }
                                const res = await fetch(`https://api.jikan.moe/v4/characters?q=${encodeURIComponent(search)}&limit=25`);
                                const d = await res.json();
                                setResults(d.data?.map(m => ({ id: m.mal_id, title: m.name, image: m.images.webp.image_url })) || []);
                            } else {
                                let url = `https://api.jikan.moe/v4/anime?q=${encodeURIComponent(search)}&limit=15`;
                                if (filters.type) url += `&type=${filters.type}`;
                                const r = await fetch(url);
                                const d = await r.json();
                                setResults(d.data?.map(m => ({ id: m.mal_id, title: m.title_english || m.title || m.name, image: m.images.webp.large_image_url || m.images.webp.image_url })) || []);
                            }
                        } catch(e) {} finally { setSearching(false); }
                    }, 600);
                    return () => clearTimeout(timer);
                } else setResults([]);
            }, [search, searchType, filters]);

            const changeGridSize = async (newSize) => {
                if (user.uid !== owner) return;
                const roomRef = fb.doc(fb.db, 'artifacts', appId, 'public', 'data', 'rooms', roomId);
                await fb.updateDoc(roomRef, {
                    gridSize: newSize,
                    grid: Array(newSize * newSize).fill(null),
                    topCats: shuffleAndPick(CAT_PHYSICAL, newSize),
                    leftCats: shuffleAndPick(CAT_TRAITS, newSize),
                    winnerUid: null,
                    turnUid: user.uid
                });
            };

            const selectItem = async (item) => {
                if (activeCell === null) return;
                const roomRef = fb.doc(fb.db, 'artifacts', appId, 'public', 'data', 'rooms', roomId);
                const snap = await fb.getDoc(roomRef);
                if (!snap.exists()) return;
                const d = snap.data();
                const latestGrid = [...(d.grid || Array(gridSize * gridSize).fill(null))];
                const order = d.playerOrder || [];
                latestGrid[activeCell] = { title: item.title, image: item.image || null, uid: user.uid, by: playerName || 'ไม่ระบุชื่อ' };
                
                const checkWin = (g, s) => {
                    const checkLine = (indices) => indices.every(idx => g[idx] && g[idx].uid === user.uid);
                    for (let r = 0; r < s; r++) {
                        const row = []; for (let c = 0; c < s; c++) row.push(r * s + c);
                        if (checkLine(row)) return true;
                    }
                    for (let c = 0; c < s; c++) {
                        const col = []; for (let r = 0; r < s; r++) col.push(r * s + c);
                        if (checkLine(col)) return true;
                    }
                    const d1 = [], d2 = [];
                    for (let i = 0; i < s; i++) {
                        d1.push(i * s + i);
                        d2.push(i * s + (s - 1 - i));
                    }
                    if (checkLine(d1) || checkLine(d2)) return true;
                    return false;
                };

                const won = checkWin(latestGrid, gridSize);
                const nextTurn = order[(order.indexOf(user.uid) + 1) % order.length];
                await fb.updateDoc(roomRef, { grid: latestGrid, turnUid: won ? user.uid : nextTurn, winnerUid: won ? user.uid : null });
                setActiveCell(null); setSearch('');
            };

            const isTurn = user.uid === turnUid;

            return (
                <div className="flex-1 p-6 flex flex-col items-center animate-slide-up">
                    <div className="w-full max-w-6xl flex flex-wrap justify-between items-center mb-6 gap-4 bg-[#262626]/50 p-4 rounded-[2rem] border border-white/5">
                        <button onClick={onBack} className="text-neutral-500 font-bold flex items-center hover:text-white transition-colors thai-header px-4"><Icon name="back" className="mr-2" size={18} /> กลับหน้าหลัก</button>
                        
                        <div className="flex flex-wrap items-center gap-4">
                            {user.uid === owner && (
                                <div className="bg-[#262626] p-1 rounded-xl border border-white/5 flex gap-1">
                                    {[3, 4, 5].map(s => (
                                        <button key={s} onClick={() => changeGridSize(s)} className={`px-3 py-1.5 rounded-lg text-[10px] font-black transition-all ${gridSize === s ? 'bg-indigo-600 text-white shadow-lg' : 'text-neutral-500 hover:text-white'}`}>
                                            {s}x{s}
                                        </button>
                                    ))}
                                </div>
                            )}

                            <div className={`px-5 py-2 rounded-xl border font-bold transition-all shadow-md text-sm thai-header ${isTurn && !winnerUid ? 'bg-indigo-600 text-white' : 'bg-[#1a1a1a] text-neutral-500 border-white/5'}`}>
                                {winnerUid ? 'จบเกมแล้ว' : isTurn ? 'ตาของคุณ' : players[turnUid] ? `ตาของ ${players[turnUid].toUpperCase()}` : 'กำลังรอ...'}
                            </div>

                            <div className="flex items-center gap-2 bg-[#1a1a1a] p-1.5 rounded-xl border border-white/5">
                                <div className="flex -space-x-2 overflow-hidden px-2 max-w-[150px]">
                                    {Object.entries(players).map(([uid, name]) => (
                                        <div key={uid} title={name} className={`w-7 h-7 rounded-full border-2 flex items-center justify-center text-[10px] font-black uppercase shrink-0 transition-all ${uid === turnUid ? 'bg-indigo-600 border-indigo-400 text-white ring-2 ring-indigo-500/30 z-10' : 'bg-[#333] border-[#444] text-neutral-400'}`}>
                                            {name.charAt(0)}
                                        </div>
                                    ))}
                                </div>
                                <div className="bg-indigo-600/20 px-4 py-1.5 rounded-lg font-mono text-indigo-400 font-black text-xs tracking-widest uppercase shadow-inner">ห้อง: {roomId}</div>
                            </div>
                        </div>
                    </div>

                    <div className="bg-[#262626] p-4 md:p-8 rounded-[3rem] border border-white/5 w-full max-w-5xl overflow-x-auto shadow-2xl custom-scrollbar">
                        <div className="grid gap-2 md:gap-4 min-w-[500px]" style={{ gridTemplateColumns: `repeat(${gridSize + 1}, minmax(0, 1fr))` }}>
                            <div className="aspect-square"></div>
                            {topCats.slice(0, gridSize).map((c, i) => <div key={i} className="aspect-square bg-indigo-900/30 rounded-2xl flex items-center justify-center p-3 text-center font-black text-indigo-300 text-sm md:text-2xl leading-tight border border-indigo-500/10 shadow-inner uppercase thai-header">{c}</div>)}
                            {leftCats.slice(0, gridSize).map((lc, r) => (
                                <Fragment key={r}>
                                    <div className="aspect-square bg-pink-900/30 rounded-2xl flex items-center justify-center p-3 text-center font-black text-pink-300 text-sm md:text-2xl leading-tight border border-pink-500/10 shadow-inner uppercase thai-header">{lc}</div>
                                    {Array.from({length: gridSize}).map((_, c) => {
                                        const idx = r * gridSize + c;
                                        const cell = grid[idx];
                                        const isMine = cell && cell.uid === user.uid;
                                        return (
                                            <button 
                                                key={c} 
                                                disabled={!isTurn || !!cell || winnerUid} 
                                                onClick={() => setActiveCell(idx)} 
                                                className={`aspect-square rounded-2xl overflow-hidden relative flex items-center justify-center transition-all ${cell ? (isMine ? 'border-4 border-green-500' : 'border-4 border-pink-500 scale-95 opacity-80') : 'bg-[#1a1a1a] hover:bg-indigo-500/10 shadow-inner border border-white/5'}`}
                                            >
                                                {cell ? (cell.image ? <img src={cell.image} className="w-full h-full object-cover" /> : <div className="p-2 text-center text-[10px] md:text-sm font-black text-white leading-tight thai-header">{cell.title}</div>) : (isTurn && !winnerUid && <div className="text-indigo-500/20 text-4xl font-black">+</div>)}
                                                {cell && <div className="absolute bottom-1 right-1 bg-black/60 text-[8px] px-1.5 rounded text-white font-bold">{cell.by}</div>}
                                            </button>
                                        );
                                    })}
                                </Fragment>
                            ))}
                        </div>
                    </div>

                    {winnerUid && !dismissWin && (
                        <div className="fixed inset-0 z-[200] bg-black/80 backdrop-blur-xl flex flex-col items-center justify-center p-6 text-center animate-slide-up">
                            <Icon name="trophy" size={120} className="text-yellow-400 mb-8 animate-victory mx-auto" />
                            <h2 className="text-8xl font-black text-white mb-4 uppercase tracking-tighter thai-header">BINGO!</h2>
                            <p className="text-3xl text-indigo-400 font-bold mb-12 thai-header">{players[winnerUid]} ชนะการแข่งขัน!</p>
                            <div className="flex gap-4">
                                <button onClick={() => setDismissWin(true)} className="bg-white/10 px-10 py-5 rounded-3xl font-black text-xl thai-header">ดูตารางผลลัพธ์</button>
                                {user.uid === owner && <button onClick={() => changeGridSize(gridSize)} className="btn-primary px-10 py-5 rounded-3xl font-black text-xl thai-header">เริ่มเกมใหม่</button>}
                            </div>
                        </div>
                    )}

                    {activeCell !== null && (
                        <SearchInterface 
                            search={search} setSearch={setSearch} 
                            searchType={searchType} setSearchType={setSearchType}
                            results={results} searching={searching}
                            filters={filters} setFilters={setFilters}
                            onSelect={selectItem} onCancel={() => setActiveCell(null)}
                        />
                    )}
                </div>
            );
        }

        // --- YES/NO GUESSING GAME ---
        function GuessingGame({ fb, appId, roomId, onBack, user, playerName }) {
            const [roomData, setRoomData] = useState(null);
            const [search, setSearch] = useState('');
            const [searchType, setSearchType] = useState('anime'); 
            const [filters, setFilters] = useState({ type: '' });
            const [results, setResults] = useState([]);
            const [picking, setPicking] = useState(false);
            const [searching, setSearching] = useState(false);
            const [hintText, setHintText] = useState('');

            useEffect(() => {
                const roomRef = fb.doc(fb.db, 'artifacts', appId, 'public', 'data', 'rooms', roomId);
                return fb.onSnapshot(roomRef, (snap) => { if (snap.exists()) setRoomData(snap.data()); });
            }, []);

            useEffect(() => {
                if (searchType !== 'custom' && search.trim().length >= 2) {
                    const t = setTimeout(async () => {
                        setSearching(true);
                        try {
                            if (searchType === 'character') {
                                const animeRes = await fetch(`https://api.jikan.moe/v4/anime?q=${encodeURIComponent(search)}&limit=1`);
                                const animeData = await animeRes.json();
                                if (animeData.data && animeData.data.length > 0) {
                                    const mal_id = animeData.data[0].mal_id;
                                    const charRes = await fetch(`https://api.jikan.moe/v4/anime/${mal_id}/characters`);
                                    const charData = await charRes.json();
                                    if (charData.data) {
                                        setResults(charData.data.map(c => ({
                                            title: c.character.name,
                                            image: c.character.images.webp.image_url
                                        })));
                                        setSearching(false);
                                        return;
                                    }
                                }
                                const res = await fetch(`https://api.jikan.moe/v4/characters?q=${encodeURIComponent(search)}&limit=30`);
                                const d = await res.json();
                                setResults(d.data?.map(m => ({ title: m.name, image: m.images.webp.image_url })) || []);
                            } else {
                                let url = `https://api.jikan.moe/v4/anime?q=${encodeURIComponent(search)}&limit=10`;
                                if (filters.type) url += `&type=${filters.type}`;
                                const r = await fetch(url);
                                const d = await r.json();
                                setResults(d.data?.map(m => ({ title: m.title_english || m.title || m.name, image: m.images.webp.large_image_url || m.images.webp.image_url })) || []);
                            }
                        } catch(e) {} finally { setSearching(false); }
                    }, 600);
                    return () => clearTimeout(t);
                } else setResults([]);
            }, [search, searchType, filters]);

            const setSecret = async (item) => {
                const roomRef = fb.doc(fb.db, 'artifacts', appId, 'public', 'data', 'rooms', roomId);
                await fb.updateDoc(roomRef, { [`secrets.${user.uid}`]: { title: item.title, image: item.image || null }, [`reveals.${user.uid}`]: false });
                setPicking(false); setSearch('');
            };

            const revealMyAnswer = async () => {
                const roomRef = fb.doc(fb.db, 'artifacts', appId, 'public', 'data', 'rooms', roomId);
                await fb.updateDoc(roomRef, { [`reveals.${user.uid}`]: true });
            };

            const restartRound = async () => {
                const roomRef = fb.doc(fb.db, 'artifacts', appId, 'public', 'data', 'rooms', roomId);
                await fb.updateDoc(roomRef, { secrets: {}, reveals: {}, hints: {} });
            };

            const requestHint = async (targetUid, syl) => {
                const roomRef = fb.doc(fb.db, 'artifacts', appId, 'public', 'data', 'rooms', roomId);
                await fb.updateDoc(roomRef, { [`hints.${targetUid}.${user.uid}`]: { type: syl, text: null, status: 'requested' } });
            };

            const provideHint = async (requesterUid) => {
                if (!hintText.trim()) return;
                const roomRef = fb.doc(fb.db, 'artifacts', appId, 'public', 'data', 'rooms', roomId);
                await fb.updateDoc(roomRef, { [`hints.${user.uid}.${requesterUid}.text`]: hintText.trim(), [`hints.${user.uid}.${requesterUid}.status`]: 'provided' });
                setHintText('');
            };

            if (!roomData) return null;

            const playerIds = Object.keys(roomData.players || {});
            const everyoneRevealed = playerIds.length > 0 && playerIds.every(id => roomData.reveals?.[id]);
            const isOwner = user.uid === roomData.owner;
            const myHintsRequested = roomData.hints?.[user.uid] || {};

            return (
                <div className="flex-1 p-6 flex flex-col items-center animate-slide-up">
                    <div className="w-full max-w-4xl flex flex-wrap justify-between items-center mb-10 bg-[#262626]/50 p-4 rounded-[2rem] border border-white/5">
                        <button onClick={onBack} className="text-neutral-500 font-bold flex items-center hover:text-white transition-colors thai-header px-4"><Icon name="back" className="mr-2" size={18} /> ออกจากห้อง</button>
                        <div className="flex items-center gap-4">
                            <div className="bg-pink-600/20 px-6 py-2.5 rounded-xl font-mono text-pink-400 font-black text-sm tracking-widest border border-pink-500/20 shadow-inner uppercase thai-header">โหมดทายตัวละครลับ</div>
                            <div className="bg-neutral-800 px-5 py-2.5 rounded-xl font-mono text-neutral-400 font-black text-sm tracking-widest border border-white/5 uppercase">ห้อง: {roomId}</div>
                        </div>
                    </div>
                    
                    <div className="w-full max-w-4xl grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div className="space-y-6">
                            <div className="bg-[#262626] p-8 rounded-[3rem] border border-white/5 shadow-2xl flex flex-col items-center text-center">
                                <h3 className="text-xl font-black text-neutral-500 mb-6 uppercase tracking-[0.2em] thai-header">ตัวละครลับของคุณ</h3>
                                {roomData.secrets?.[user.uid] ? (
                                    <div className="w-full space-y-6">
                                        <div className="bg-indigo-500/10 border-2 border-indigo-500/30 p-8 rounded-[2rem] w-full relative">
                                            {roomData.secrets[user.uid].image ? <img src={roomData.secrets[user.uid].image} className="w-24 h-32 object-cover rounded-2xl mx-auto mb-4 border border-indigo-500/30" /> : <div className="w-24 h-32 bg-indigo-500/20 rounded-2xl mx-auto mb-4 flex items-center justify-center border border-indigo-500/30"><Icon name="user" className="text-indigo-400" size={32} /></div>}
                                            <p className="text-3xl font-black text-indigo-400 mb-2 leading-tight thai-header">{roomData.secrets[user.uid].title}</p>
                                        </div>
                                        {!roomData.reveals?.[user.uid] && <button onClick={revealMyAnswer} className="w-full py-5 bg-red-600/20 text-red-400 border border-red-500/30 rounded-2xl font-black text-xl hover:bg-red-600 hover:text-white transition-all thai-header">เฉลยตัวละครของฉัน</button>}
                                    </div>
                                ) : (
                                    <button onClick={() => setPicking(true)} className="w-full py-10 border-4 border-dashed border-white/5 rounded-[2rem] text-indigo-400 font-black text-2xl hover:bg-indigo-500/5 transition-all thai-header">เลือกตัวละครลับ</button>
                                )}
                            </div>

                            {/* My Hint Requests Panel */}
                            {Object.keys(myHintsRequested).filter(id => myHintsRequested[id].status === 'requested').length > 0 && (
                                <div className="bg-[#262626] p-6 rounded-[2rem] border border-indigo-500/30 shadow-2xl animate-slide-up">
                                    <h4 className="text-sm font-black text-indigo-400 mb-4 uppercase tracking-widest flex items-center gap-2 thai-header"><Icon name="message" size={16} /> คำขอคำใบ้จากเพื่อน</h4>
                                    <div className="space-y-4">
                                        {Object.entries(myHintsRequested).filter(([_, h]) => h.status === 'requested').map(([reqId, hint]) => (
                                            <div key={reqId} className="bg-[#1a1a1a] p-4 rounded-2xl border border-white/5 space-y-3">
                                                <p className="text-xs font-bold text-neutral-400 thai-header">
                                                    <span className="text-white uppercase">{roomData.players[reqId]}</span> ขอคำใบ้แบบ <span className="text-indigo-400">{hint.type} พยางค์</span>
                                                </p>
                                                <div className="flex gap-2">
                                                    <input 
                                                        value={hintText} 
                                                        onChange={e => setHintText(e.target.value)}
                                                        className="flex-1 bg-[#171717] border border-white/5 rounded-xl px-4 py-2 text-sm text-white focus:outline-none" 
                                                        placeholder="พิมพ์คำใบ้..." 
                                                    />
                                                    <button onClick={() => provideHint(reqId)} className="bg-indigo-600 text-white px-4 py-2 rounded-xl text-xs font-bold thai-header">ส่ง</button>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            )}
                        </div>

                        <div className="bg-[#262626] p-8 rounded-[3rem] border border-white/5 shadow-2xl">
                            <h3 className="text-xl font-black text-neutral-500 mb-6 uppercase tracking-[0.2em] thai-header">ผู้เล่นคนอื่นๆ</h3>
                            <div className="space-y-4 max-h-[65vh] overflow-y-auto custom-scrollbar pr-2">
                                {Object.entries(roomData.players).filter(([id]) => id !== user.uid).map(([uid, name]) => {
                                    const secretSet = roomData.secrets?.[uid];
                                    const revealed = roomData.reveals?.[uid];
                                    const myHintRequestToThem = roomData.hints?.[uid]?.[user.uid];

                                    return (
                                        <div key={uid} className={`p-5 rounded-2xl border transition-all ${revealed ? 'bg-pink-500/5 border-pink-500/20' : 'bg-[#1a1a1a] border-white/5'}`}>
                                            <div className="flex justify-between items-center mb-2">
                                                <span className="font-black text-lg thai-header uppercase">{name}</span>
                                                {revealed && <span className="text-[8px] bg-pink-500 text-white px-2 py-0.5 rounded-full font-black uppercase thai-header">เฉลยแล้ว</span>}
                                            </div>
                                            
                                            {revealed ? (
                                                <div className="mt-2 pt-4 border-t border-white/5 text-center flex flex-col items-center">
                                                    {roomData.secrets[uid].image ? <img src={roomData.secrets[uid].image} className="w-20 h-28 object-cover rounded-xl mx-auto mb-2" /> : <div className="w-20 h-28 bg-white/5 rounded-xl mx-auto mb-2 flex items-center justify-center"><Icon name="user" className="text-neutral-600" size={24} /></div>}
                                                    <p className="font-black text-white thai-header">{roomData.secrets[uid].title}</p>
                                                </div>
                                            ) : (
                                                <div className="mt-4 space-y-3">
                                                    {!myHintRequestToThem ? (
                                                        <div className="flex gap-1.5 flex-wrap">
                                                            <span className="text-[10px] font-black text-neutral-500 w-full mb-1 thai-header uppercase">ขอคำใบ้:</span>
                                                            {[1, 2, 3].map(n => (
                                                                <button 
                                                                    key={n}
                                                                    disabled={!secretSet}
                                                                    onClick={() => requestHint(uid, n)}
                                                                    className={`px-2.5 py-1.5 rounded-lg text-[10px] font-black border transition-all thai-header ${secretSet ? 'bg-[#1a1a1a] hover:bg-indigo-600 text-white border-white/5' : 'bg-neutral-800 text-neutral-600 border-transparent cursor-not-allowed'}`}
                                                                >
                                                                    {n} พยางค์
                                                                </button>
                                                            ))}
                                                        </div>
                                                    ) : myHintRequestToThem.status === 'requested' ? (
                                                        <div className="bg-indigo-900/20 border border-indigo-500/20 p-3 rounded-xl flex items-center justify-center gap-2">
                                                            <div className="w-1.5 h-1.5 rounded-full bg-indigo-400 hint-pulse"></div>
                                                            <span className="text-[10px] font-black text-indigo-400 uppercase thai-header tracking-wider">กำลังรอคำใบ้ ({myHintRequestToThem.type} พยางค์)...</span>
                                                        </div>
                                                    ) : (
                                                        <div className="bg-green-500/10 border border-green-500/20 p-4 rounded-xl space-y-1 animate-slide-up">
                                                            <span className="text-[9px] font-black text-green-500 uppercase tracking-widest thai-header">คำใบ้ ({myHintRequestToThem.type} พยางค์):</span>
                                                            <p className="text-lg font-black text-white thai-header leading-tight">"{myHintRequestToThem.text}"</p>
                                                        </div>
                                                    )}
                                                    {!secretSet && <p className="text-[9px] text-neutral-500 thai-header italic mt-2">* รอเพื่อนเลือกตัวละครถึงจะขอคำใบ้ได้</p>}
                                                </div>
                                            )}
                                        </div>
                                    );
                                })}
                                {Object.keys(roomData.players).length <= 1 && (
                                    <div className="py-20 text-center text-neutral-600 font-black thai-header opacity-50 uppercase tracking-widest">กำลังรอผู้เล่นคนอื่นๆ...</div>
                                )}
                            </div>
                        </div>
                    </div>

                    {everyoneRevealed && isOwner && (
                        <div className="w-full max-w-4xl mt-8 animate-slide-up">
                            <button onClick={restartRound} className="w-full py-5 bg-indigo-600 text-white rounded-[2rem] font-black text-2xl shadow-xl hover:bg-indigo-700 transition-all active:scale-95 thai-header uppercase tracking-wider">เริ่มรอบใหม่</button>
                        </div>
                    )}

                    {picking && (
                        <SearchInterface 
                            search={search} setSearch={setSearch} 
                            searchType={searchType} setSearchType={setSearchType}
                            results={results} searching={searching}
                            filters={filters} setFilters={setFilters}
                            onSelect={setSecret} onCancel={() => setPicking(false)}
                        />
                    )}
                </div>
            );
        }

        // --- TIER LIST GAME ---
        function TierListGame({ fb, appId, roomId, onBack, user, playerName }) {
            const [roomData, setRoomData] = useState(null);
            const [search, setSearch] = useState('');
            const [searchType, setSearchType] = useState('anime_single');
            const [filters, setFilters] = useState({ type: '' });
            const [results, setResults] = useState([]);
            const [searching, setSearching] = useState(false);
            const [adding, setAdding] = useState(false);
            const [dragOverTierId, setDragOverTierId] = useState(null);
            const [dragOverItemId, setDragOverItemId] = useState(null);

            useEffect(() => {
                const roomRef = fb.doc(fb.db, 'artifacts', appId, 'public', 'data', 'rooms', roomId);
                return fb.onSnapshot(roomRef, (snap) => { if (snap.exists()) setRoomData(snap.data()); });
            }, []);

            useEffect(() => {
                if (search.trim().length >= 2) {
                    const t = setTimeout(async () => {
                        setSearching(true);
                        try {
                            const isAnimeSearch = searchType === 'anime_single' || searchType === 'anime_chars';
                            if (searchType === 'character') {
                                const animeRes = await fetch(`https://api.jikan.moe/v4/anime?q=${encodeURIComponent(search)}&limit=1`);
                                const animeData = await animeRes.json();
                                if (animeData.data && animeData.data.length > 0) {
                                    const mal_id = animeData.data[0].mal_id;
                                    const charRes = await fetch(`https://api.jikan.moe/v4/anime/${mal_id}/characters`);
                                    const charData = await charRes.json();
                                    if (charData.data) {
                                        setResults(charData.data.map(c => ({
                                            id: c.character.mal_id,
                                            title: c.character.name,
                                            image: c.character.images.webp.image_url
                                        })));
                                        setSearching(false);
                                        return;
                                    }
                                }
                                const res = await fetch(`https://api.jikan.moe/v4/characters?q=${encodeURIComponent(search)}&limit=30`);
                                const d = await res.json();
                                setResults(d.data?.map(m => ({ id: m.mal_id, title: m.name, image: m.images.webp.image_url })) || []);
                            } else {
                                let url = `https://api.jikan.moe/v4/anime?q=${encodeURIComponent(search)}&limit=15`;
                                if (filters.type) url += `&type=${filters.type}`;
                                const r = await fetch(url);
                                const d = await r.json();
                                setResults(d.data?.map(m => ({ id: m.mal_id, title: m.title_english || m.title || m.name, image: m.images?.webp?.large_image_url || m.images?.webp?.image_url })) || []);
                            }
                        } catch(e) {} finally { setSearching(false); }
                    }, 600);
                    return () => clearTimeout(t);
                } else setResults([]);
            }, [search, searchType, filters]);

            const addItem = async (r) => {
                const roomRef = fb.doc(fb.db, 'artifacts', appId, 'public', 'data', 'rooms', roomId);
                if (searchType === 'anime_chars') {
                    const res = await fetch(`https://api.jikan.moe/v4/anime/${r.id}/characters`);
                    const data = await res.json();
                    if (data.data) {
                        const newChars = data.data.map(c => ({
                            id: c.character.mal_id, title: c.character.name, image: c.character.images.webp.image_url, instanceId: Math.random().toString(36).substring(7), tier: 'unranked'
                        }));
                        await fb.updateDoc(roomRef, { tierItems: [...(roomData.tierItems || []), ...newChars] });
                    }
                } else {
                    await fb.updateDoc(roomRef, { tierItems: fb.arrayUnion({ ...r, instanceId: Math.random().toString(36).substring(7), tier: 'unranked' }) });
                }
                setAdding(false); setSearch('');
            };

            const updateItemTier = async (instanceId, newTier) => {
                const roomRef = fb.doc(fb.db, 'artifacts', appId, 'public', 'data', 'rooms', roomId);
                const updatedItems = roomData.tierItems.map(item => item.instanceId === instanceId ? { ...item, tier: newTier } : item);
                await fb.updateDoc(roomRef, { tierItems: updatedItems });
            };

            const reorderItem = async (sourceId, targetId) => {
                if (sourceId === targetId) return;
                const roomRef = fb.doc(fb.db, 'artifacts', appId, 'public', 'data', 'rooms', roomId);
                const items = [...roomData.tierItems];
                const sIdx = items.findIndex(i => i.instanceId === sourceId);
                const tIdx = items.findIndex(i => i.instanceId === targetId);
                const targetTier = items[tIdx].tier;
                const [movedItem] = items.splice(sIdx, 1);
                movedItem.tier = targetTier;
                const newTIdx = items.findIndex(i => i.instanceId === targetId);
                items.splice(newTIdx, 0, movedItem);
                await fb.updateDoc(roomRef, { tierItems: items });
            };

            const onDragStart = (e, instanceId) => { e.dataTransfer.setData("instanceId", instanceId); };
            const onDropOnTier = async (e, tierId) => {
                e.preventDefault(); setDragOverTierId(null); setDragOverItemId(null);
                const instanceId = e.dataTransfer.getData("instanceId");
                if (instanceId) await updateItemTier(instanceId, tierId);
            };
            const onDropOnItem = async (e, targetId) => {
                e.preventDefault(); e.stopPropagation(); setDragOverTierId(null); setDragOverItemId(null);
                const sourceId = e.dataTransfer.getData("instanceId");
                if (sourceId) await reorderItem(sourceId, targetId);
            };

            if (!roomData) return null;

            return (
                <div className="flex-1 p-6 flex flex-col items-center animate-slide-up">
                    <div className="w-full max-w-6xl flex flex-wrap justify-between items-center mb-8 bg-[#262626]/50 p-4 rounded-[2rem] border border-white/5">
                        <button onClick={onBack} className="text-neutral-500 font-bold flex items-center hover:text-white transition-colors thai-header px-4"><Icon name="back" className="mr-2" size={18} /> กลับหน้าหลัก</button>
                        <div className="flex flex-wrap items-center gap-3">
                            <button onClick={() => setAdding(true)} className="bg-orange-600 text-white px-5 py-2 rounded-xl font-bold flex items-center hover:bg-orange-700 transition-all shadow-md thai-header text-sm"><Icon name="sparkles" size={16} className="mr-1.5" /> เพิ่มรายการ</button>
                            <div className="flex items-center gap-2 bg-[#1a1a1a] p-1.5 rounded-xl border border-white/5">
                                <div className="flex -space-x-2 overflow-hidden px-2 max-w-[150px]">
                                    {Object.entries(roomData.players || {}).map(([uid, name]) => <div key={uid} title={name} className={`w-7 h-7 rounded-full border-2 flex items-center justify-center text-[10px] font-black uppercase shrink-0 transition-all ${uid === user.uid ? 'bg-orange-600 border-orange-400 text-white ring-2 ring-orange-500/30 z-10' : 'bg-[#333] border-[#444] text-neutral-400'}`}>{name.charAt(0)}</div>)}
                                </div>
                                <div className="bg-orange-600/20 px-4 py-1.5 rounded-lg font-mono text-orange-400 font-black text-xs tracking-widest uppercase shadow-inner">ห้อง: {roomId}</div>
                            </div>
                        </div>
                    </div>

                    <div className="w-full max-w-6xl space-y-4">
                        {(roomData.tiers || []).map(tier => (
                            <div key={tier.id} onDragOver={e => { e.preventDefault(); setDragOverTierId(tier.id); }} onDragLeave={() => setDragOverTierId(null)} onDrop={e => onDropOnTier(e, tier.id)} className={`flex bg-[#262626] rounded-2xl overflow-hidden border border-white/5 shadow-xl transition-all ${dragOverTierId === tier.id ? 'drag-over' : ''}`}>
                                <div className={`${tier.color} w-28 md:w-32 flex flex-col items-center justify-center p-2 text-center shadow-inner relative group`}><span className="text-2xl md:text-3xl font-black text-black/70">{tier.label}</span></div>
                                <div className="flex-1 p-4 flex flex-wrap gap-4 tier-row">{(roomData.tierItems || []).filter(i => i.tier === tier.id).map(item => (
                                    <div key={item.instanceId} draggable onDragStart={e => onDragStart(e, item.instanceId)} onDragOver={e => { e.preventDefault(); e.stopPropagation(); setDragOverItemId(item.instanceId); }} onDragLeave={() => setDragOverItemId(null)} onDrop={e => onDropOnItem(e, item.instanceId)} className={`relative group/item cursor-grab active:cursor-grabbing transition-all ${dragOverItemId === item.instanceId ? 'item-drag-target' : ''}`}>
                                        <img src={item.image} className="w-20 h-28 object-cover rounded-xl shadow-lg border border-white/5 group-hover/item:scale-105 transition-transform" />
                                        <div className="absolute inset-0 bg-black/60 opacity-0 group-hover/item:opacity-100 transition-opacity flex flex-col items-center justify-center rounded-xl"><button onClick={() => updateItemTier(item.instanceId, 'unranked')} className="bg-red-500 text-white p-2 rounded-full shadow-lg"><Icon name="close" size={20} /></button></div>
                                    </div>
                                ))}</div>
                            </div>
                        ))}

                        <div className="mt-12">
                            <div className="flex justify-between items-center mb-6 border-b border-white/5 pb-4"><h3 className="text-xl font-bold text-neutral-500 uppercase tracking-widest thai-header">คลังรายการ (ยังไม่จัดอันดับ)</h3></div>
                            <div onDragOver={e => { e.preventDefault(); setDragOverTierId('unranked'); }} onDragLeave={() => setDragOverTierId(null)} onDrop={e => onDropOnTier(e, 'unranked')} className={`flex flex-wrap gap-6 min-h-[180px] p-8 bg-[#1a1a1a] rounded-[3rem] border border-white/5 shadow-inner transition-all ${dragOverTierId === 'unranked' ? 'drag-over' : ''}`}>{(roomData.tierItems || []).filter(i => i.tier === 'unranked').map(item => (
                                <div key={item.instanceId} draggable onDragStart={e => onDragStart(e, item.instanceId)} className="relative group/item cursor-grab active:cursor-grabbing transition-all">
                                    <img src={item.image} className="w-24 h-32 object-cover rounded-xl shadow-lg border border-white/5 group-hover/item:scale-105 transition-transform" />
                                    <p className="text-[10px] text-center mt-2 font-bold text-neutral-500 line-clamp-1 w-24 thai-header uppercase">{item.title}</p>
                                    <div className="absolute inset-0 bg-black/60 opacity-0 group-hover/item:opacity-100 transition-opacity flex flex-col items-center justify-center rounded-xl"><button onClick={() => {const f = roomData.tierItems.filter(i => i.instanceId !== item.instanceId); fb.updateDoc(fb.doc(fb.db, 'artifacts', appId, 'public', 'data', 'rooms', roomId), { tierItems: f });}} className="bg-red-500 text-white p-2 rounded-full shadow-lg"><Icon name="close" size={18} /></button></div>
                                </div>
                            ))}</div>
                        </div>
                    </div>

                    {adding && (
                        <SearchInterface 
                            search={search} setSearch={setSearch} 
                            searchType={searchType === 'anime_single' || searchType === 'anime_chars' ? 'anime' : searchType} 
                            setSearchType={(t) => setSearchType(t === 'anime' ? 'anime_single' : t)}
                            results={results} searching={searching}
                            filters={filters} setFilters={setFilters}
                            onSelect={addItem} onCancel={() => setAdding(false)}
                        />
                    )}
                </div>
            );
        }

        const root = document.getElementById('root');
        ReactDOM.createRoot(root).render(<App />);
    </script>
</body>
</html>
